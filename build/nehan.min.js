/*
 nehan.js
 Copyright (C) 2010 Watanabe Masaki<lambda.watanabe[at]gmail.com>
 http://tategakibunko.mydns.jp/docs/nehan/

 licensed under MIT licence.

 Permission is hereby granted, free of charge, to any person
 obtaining a copy of this software and associated documentation
 files (the "Software"), to deal in the Software without
 restriction, including without limitation the rights to use,
 copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the
 Software is furnished to do so, subject to the following
 conditions:

 The above copyright notice and this permission notice shall be
 included in all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
 HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
 WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.
*/

var Nehan;Nehan||(Nehan={}),Nehan.setup=function(t){var e=t||{},n={lang:"ja-JP",kerning:!0,justify:!0,maxRollbackCount:10,minBlockScaleDownRate:65,useVerticalGlyphIfEnable:!0,lexingBufferLen:2e3},i={root:"body",direction:"vert",hori:"lr-tb",vert:"tb-rl",width:800,height:580,fontSize:16,rubyRate:.5,boldRate:.2,fontColor:"000000",linkColor:"0000FF",fontImgRoot:"http://nehan.googlecode.com/hg/char-img",lineRate:2,listMarkerSpacingRate:.4,createBox:function(t,e,n){var i=new ce(t,e,n);return i.flow=e.flow,i.lineRate=e.lineRate,i.textAlign=e.textAlign,i.fontSize=e.fontSize,i.color=e.color,i.letterSpacing=e.letterSpacing,i},createTextLine:function(t,e){return this.createBox(t,e,"text-line")},createRootBox:function(t,e){var n=new ce(t,null,e);return n.flow=this.getStdBoxFlow(),n.lineRate=this.lineRate,n.textAlign="start",n.fontSize=this.fontSize,n.color=new P(this.fontColor),n.letterSpacing=0,n},getStdPageSize:function(){return new se(this.width,this.height)},getStdMeasure:function(){var t=this.getStdBoxFlow();return this[t.getPropMeasure()]},getStdBoxFlow:function(){var t=this[this.direction];return G.getByName(t)},getStdVertFlow:function(){return G.getByName(this.vert)},getStdHoriFlow:function(){return G.getByName(this.hori)},getListMarkerSpacingSize:function(t){return t=t||this.fontSize,Math.floor(t*this.listMarkerSpacingRate)},getVertBlockDir:function(){return this.vert.split("-")[1]},getHoriIndir:function(){return this.hori.split("-")[0]},getRubyFontSize:function(t){var e=s.rt||null,n=e?e["font-size"]:null;return null===e||null===n?Math.floor(this.rubyRate*t):h.getUnitSize(n,t)},getPaletteFontColor:function(t){return t.getValue().toLowerCase()!==this.fontColor.toLowerCase()?t.getPaletteValue():this.fontColor}},r=function(){var t,e,n,i=navigator.appName,r=navigator.userAgent.toLowerCase(),s=r.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/);s?(tmp_match=r.match(/version\/([\.\d]+)/i),tmp_match&&(s[2]=tmp_match[1]),t=s[1].toLowerCase(),e=parseInt(s[2],10),n="msie"===t?this.version>=9:!0):(t=i.toLowerCase(),e=parseInt(navigator.appVersion,10),n=!1);var a="msie"===t,o=r.indexOf("windows")>=0,u=r.indexOf("macintosh")>=0,h=t.indexOf("chrome")>=0,l=-1!=r.indexOf("iphone"),c=-1!=r.indexOf("ipod"),f=-1!=r.indexOf("ipad"),g=l||c||f,d=-1!=r.indexOf("android"),p=g||d,m=-1!=r.indexOf("webkit"),x=h&&(o||u)&&e>=24;return{version:e,isIE:a,isChrome:h,isWebkit:m,isIphone:l,isIpod:c,isIpad:f,isIphoneFamily:g,isAndroidFamily:d,isSmartPhone:p,isTransformEnable:n,isVerticalGlyphEnable:x}}(),s={a:{display:"inline"},abbr:{display:"inline"},address:{display:"inline",section:!0},area:{},article:{display:"block",section:!0},aside:{display:"block",section:!0},audio:{},b:{display:"inline","font-weight":"bold"},base:{},bdi:{display:"inline"},bdo:{display:"inline"},blockquote:{display:"block","section-root":!0,padding:{start:"1em",end:"1em",before:"0.5em",after:"0.5em"},margin:{after:"1.5em"}},body:{display:"block","section-root":!0},br:{display:"inline",single:!0},button:{display:"inline",interactive:!0},canvas:{display:"inline",embeddable:!0},caption:{display:"block","text-align":"center",margin:{after:"0.5em"}},cite:{display:"inline"},code:{display:"inline"},col:{},colgroup:{},command:{},datalist:{},dd:{display:"block",margin:{start:"1em",end:"1em",after:"1.6em"}},del:{display:"inline"},details:{display:"block","section-root":!0},dfn:{display:"inline"},div:{display:"block",embeddable:!0},dl:{display:"block"},dt:{display:"block",margin:{after:"0.2em"}},em:{display:"inline"},embed:{},"end-page":{display:"block",single:!0},fieldset:{display:"block","section-root":!0,padding:{start:"1em",end:"0.2em",before:"0.2em",after:"1em"},margin:{after:"1.5em"},"border-width":"1px"},figure:{display:"block","section-root":!0},figcaption:{display:"block","text-align":"center","font-size":"0.8em"},footer:{display:"block",section:!0},form:{display:"block"},h1:{display:"block","line-rate":1.4,"font-size":"2.4em","font-weight":"bold",margin:{after:"0.5em"}},h2:{display:"block","line-rate":1.4,"font-size":"2.0em","font-weight":"bold",margin:{after:"0.75em"}},h3:{display:"block","line-rate":1.4,"font-size":"1.6em","font-weight":"bold",margin:{after:"1em"}},h4:{display:"block","line-rate":1.4,"font-size":"1.4em","font-weight":"bold",margin:{after:"1.25em"}},h5:{display:"block","line-rate":1.4,"font-size":"1.0em","font-weight":"bold",margin:{after:"1.5em"}},h6:{display:"block","line-rate":1.4,"font-size":"1.0em","font-weight":"bold"},head:{},header:{display:"block",section:!0},hr:{display:"block","box-sizing":"content-box",single:!0,margin:{after:"1em"},"border-width":{after:"1px"}},"hr.nehan-space":{"border-width":"0px"},html:{display:"block"},i:{display:"inline"},iframe:{display:"block",embeddable:!0},ins:{},img:{display:"inline","box-sizing":"content-box",single:!0},input:{display:"inline",interactive:!0,single:!0},kbd:{display:"inline"},keygen:{},label:{display:"inline"},legend:{display:"block","line-rate":1.5},li:{display:"block",margin:{after:"0.6em"}},link:{meta:!0,single:!0},main:{display:"block"},map:{},mark:{display:"inline"},menu:{display:"block"},meta:{meta:!0,single:!0},meter:{display:"inline"},nav:{display:"block",section:!0},noscript:{},object:{display:"inline",embeddable:!0},ol:{display:"block","list-style-image":"none","list-style-position":"outside","list-style-type":"decimal",margin:{before:"1em"}},optgroup:{},option:{},output:{},p:{display:"block",margin:{after:"1.5em"}},"page-break":{display:"block",single:!0},param:{},pre:{display:"block"},progress:{display:"inline"},q:{display:"block"},rb:{display:"inline"},rp:{display:"inline"},ruby:{display:"inline"},rt:{"font-size":"0.5em","line-rate":1,display:"inline"},s:{display:"inline"},samp:{display:"inline"},script:{display:"inline",meta:!0},section:{display:"block",section:!0},select:{},small:{display:"inline","font-size":"0.8em"},source:{},span:{display:"inline"},strong:{display:"inline","font-weight":"bold"},style:{display:"inline",meta:!0},sub:{display:"inine"},summary:{display:"inline"},sup:{display:"inine"},table:{display:"block",embeddable:!0,"table-layout":"fixed","border-collapse":"collapse","border-width":"1px",margin:{start:"0.5em",end:"0.5em",after:"1.6em"}},tbody:{display:"block","border-collapse":"inherit"},td:{display:"block","border-collapse":"inherit","section-root":!0,"border-width":"1px",padding:{start:"0.8em",end:"0.8em",before:"0.5em",after:"0.5em"}},textarea:{display:"inline",embeddable:!0,interactive:!0},tfoot:{display:"block","border-collapse":"inherit"},th:{display:"block","line-rate":1.4,"border-collapse":"inherit","border-width":"1px",padding:{start:"0.8em",end:"0.8em",before:"0.5em",after:"0.5em"}},thead:{display:"block","border-collapse":"inherit"},time:{display:"inline"},title:{meta:!0},tr:{display:"block"},track:{},u:{display:"inline"},ul:{display:"block","list-style-image":"none","list-style-type":"disc","list-style-position":"outside",margin:{before:"1em"}},"var":{display:"inline"},video:{display:"inline",embeddable:!0},wbr:{display:"inline",single:!0},".nehan-rounded":{padding:["1.6em","1.0em","1.6em","1.0em"],"border-radius":"10px"},".nehan-xx-large":{"font-size":"33px"},".nehan-x-large":{"font-size":"24px"},".nehan-large":{"font-size":"18px"},".nehan-medium":{"font-size":"16px"},".nehan-small":{"font-size":"13px"},".nehan-x-small":{"font-size":"10px"},".nehan-xx-small":{"font-size":"10px"},".nehan-larger":{"font-size":"1.2em"},".nehan-smaller":{"font-size":"0.8em"},".nehan-disp-block":{display:"block"},".nehan-disp-inline":{display:"inline"},".nehan-disp-inline-block":{display:"inline-block"},".nehan-ta-start":{"text-align":"start"},".nehan-ta-center":{"text-align":"center"},".nehan-ta-end":{"text-align":"end"},".nehan-float-start":{"float":"start"},".nehan-float-end":{"float":"end"},".nehan-flow-lr-tb":{flow:"lr-tb"},".nehan-flow-tb-rl":{flow:"tb-rl"},".nehan-flow-tb-lr":{flow:"tb-lr"},".nehan-flow-rl-tb":{flow:"rl-tb"},".nehan-flow-flip":{flow:"flip"},".nehan-flow-inherit":{"float":"inherit"},".nehan-lsp-inside":{"list-style-position":"inside"},".nehan-lsp-outside":{"list-style-position":"outside"},".nehan-lst-none":{"list-style-type":"none"},".nehan-lst-decimal":{"list-style-type":"decimal"},".nehan-lst-disc":{"list-style-type":"disc"},".nehan-lst-circle":{"list-style-type":"circle"},".nehan-lst-square":{"list-style-type":"square"},".nehan-lst-decimal-leading-zero":{"list-style-type":"decimal-leading-zero"},".nehan-lst-lower-alpha":{"list-style-type":"lower-alpha"},".nehan-lst-upper-alpha":{"list-style-type":"upper-alpha"},".nehan-lst-lower-latin":{"list-style-type":"lower-latin"},".nehan-lst-upper-latin":{"list-style-type":"upper-latin"},".nehan-lst-lower-roman":{"list-style-type":"lower-roman"},".nehan-lst-upper-roman":{"list-style-type":"upper-roman"},".nehan-lst-lower-greek":{"list-style-type":"lower-greek"},".nehan-lst-upper-greek":{"list-style-type":"upper-greek"},".nehan-lst-cjk-ideographic":{"list-style-type":"cjk-ideographic"},".nehan-lst-hiragana":{"list-style-type":"hiragana"},".nehan-lst-hiragana-iroha":{"list-style-type":"hiragana-iroha"},".nehan-lst-katakana":{"list-style-type":"katakana"},".nehan-lst-katakana-iroha":{"list-style-type":"katakana-iroha"},".nehan-tcy":{"text-combine":"horizontal"},".nehan-text-combine":{"text-combine":"horizontal"},".nehan-empha-dot-filled":{"text-emphasis-style":"&#x2022;"},".nehan-empha-dot-open":{"text-emphasis-style":"&#x25e6;"},".nehan-empha-circle-filled":{"text-emphasis-style":"&#x25cf;"},".nehan-empha-circle-open":{"text-emphasis-style":"&#x25cb;"},".nehan-empha-double-circle-filled":{"text-emphasis-style":"&#x25c9;"},".nehan-empha-double-circle-open":{"text-emphasis-style":"&#x25ce;"},".nehan-empha-triangle-filled":{"text-emphasis-style":"&#x25b2;"},".nehan-empha-triangle-open":{"text-emphasis-style":"&#x25b3;"},".nehan-empha-sesame-filled":{"text-emphasis-style":"&#xfe45;"},".nehan-empha-sesame-open":{"text-emphasis-style":"&#xfe46;"},".nehan-tip":{padding:{before:"0.1em",start:"0.8em",end:"0.8em",after:"0.8em"},margin:{after:"1em"},"border-width":"2px"},".nehan-drop-caps::first-letter":{display:"block",width:"4em",height:"4em","float":"start","line-rate":1,"font-size":"4em"},".nehan-line-no-ruby":{"line-rate":1},".nehan-gap-start":{margin:{start:"1em"}},".nehan-gap-end":{margin:{end:"1em"}},".nehan-gap-after":{margin:{after:"1em"}},".nehan-gap-before":{margin:{before:"1em"}}},a=function(){var t=!1,e=/xyz/.test(function(){})?/\b_super\b/:/.*/,n=function(){};return n.extend=function(n){function i(){!t&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;t=!0;var s=new this;t=!1;for(var a in n)s[a]="function"==typeof n[a]&&"function"==typeof r[a]&&e.test(n[a])?function(t,e){return function(){var n=this._super;this._super=r[t];var i=e.apply(this,arguments);return this._super=n,i}}(a,n[a]):n[a];return i.prototype=s,i.prototype.constructor=i,i.extend=arguments.callee,i},n}(),o={each:function(t,e){for(var n in t)e(n,t[n])},iter:function(t,e){for(var n=0,i=t.length;i>n;n++)e(t[n])},iteri:function(t,e){for(var n=0,i=t.length;i>n;n++)e(n,t[n])},reviter:function(t,e){for(var n=t.length;n>=0;n--)e(t[n])},reviteri:function(t,e){for(var n=t.length;n>=0;n--)e(n,t[n])},forall:function(t,e){for(var n=0,i=t.length;i>n;n++)if(!e(t[n]))return!1;return!0},map:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n[i]=e(t[i]);return n},mapi:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)n[i]=e(i,t[i]);return n},fold:function(t,e,n){for(var i=e,r=0,s=t.length;s>r;r++)i=n(i,t[r]);return i},filter:function(t,e){for(var n=[],i=0,r=t.length;r>i;i++)e(t[i])&&n.push(t[i]);return n},find:function(t,e){for(var n=0,i=t.length;i>n;n++){var r=t[n];if(e(r))return r}return null},revfind:function(t,e){for(var n=t.length-1;n>=0;n--){var i=t[n];if(e(i))return i}return null},indexOf:function(t,e){for(var n=0,i=t.length;i>n;n++){var r=t[n];if(e(r))return n}return-1},exists:function(t,e){for(var n=0,i=t.length;i>n;n++)if(e(t[n]))return!0;return!1},mem:function(t,e){for(var n=0,i=t.length;i>n;n++)if(t[n]==e)return!0;return!1},sum:function(t){return this.fold(t,0,function(t,e){return t+e})},minobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||i>r)&&(n=t,i=r)}),n},maxobj:function(t,e){var n=null,i=null;return this.iter(t,function(t){var r=e(t);(null===i||r>i)&&(n=t,i=r)}),n},refcopy:function(t){for(var e=[],n=0,i=t.length;i>n;n++)e[n]=t[n];return e},count:function(t,e){for(var n=0,i=0,r=t.length;r>i;i++)e(t[i])&&n++;return n},create:function(t,e){var n=Array(t);if(e!==void 0)for(var i=0;t>i;i++)n[i]=e;return n},last:function(t,e){return 0===t.length?e:t[t.length-1]},zip:function(t,e){for(var n=[],i=0,r=Math.min(t.length,e.length);r>i;i++)n[i]=[t[i],e[i]];return n},reverse:function(t){return t.reverse(),t}},u={isEmpty:function(t){for(var e in t)return!1;return!0},map:function(t,e){var n={};for(var i in t)n[i]=e(t[i]);return n},iter:function(t,e){for(var n in t)e(t,n,t[n])}},h={getUnitSize:function(t,e){var n="string"==typeof t?t:t+"";if(n.indexOf("rem")>0){var r=parseFloat(n.replace("rem",""));return Math.floor(i.fontSize*r)}if(n.indexOf("em")>0){var s=parseFloat(n.replace("em",""));return Math.floor(e*s)}if(n.indexOf("pt")>0)return Math.floor(4*parseInt(n,10)/3);if(n.indexOf("%")>0)return Math.floor(e*parseInt(n,10)/100);var a=parseInt(n,10);return isNaN(a)?0:a},getBoxSize:function(t,e,n){var i="string"==typeof t?t:t+"";if(i.indexOf("%")>0){var r=Math.floor(n*parseInt(i,10)/100);return Math.min(n,r)}return this.getUnitSize(t,e)},getCornerSize:function(t,e){var n={};for(var i in t)n[i]=[0,0],n[i][0]=this.getUnitSize(t[i][0],e),n[i][1]=this.getUnitSize(t[i][1],e);return n},getEdgeSize:function(t,e){var n={};for(var i in t)n[i]=this.getUnitSize(t[i],e);return n}},l={trimHeadCRLF:function(t){return t.replace(/^\n+/,"")},trimFootCRLF:function(t){return t.replace(/\n+$/,"")},trimCRLF:function(t){return this.trimFootCRLF(this.trimHeadCRLF(t))},trim:function(t){return t.replace(/^\s+/,"").replace(/\s+$/,"")},capitalize:function(t){return""===t?"":t.charAt(0).toUpperCase()+t.slice(1)},log:function(t,e){var n=e||10;return Math.log(t)/Math.log(n)},filenameConcat:function(t,e){return t=""===t?"":"/"===t.slice(-1)?t:t+"/",e=""===e?"":"/"===e[0]?e.substring(1,e.length):e,t+e},getCamelName:function(t){var e=this;return o.mapi(t.split("-"),function(t,n){return 0===t?n:e.capitalize(n)}).join("")}},c={convBase:function(t,e){if(0===t)return[0];for(var n=[],i=t;i>0;)n.unshift(i%e),i=Math.floor(i/e);return n}},f=function(){var t=1e3/60;return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(e,n){var i=n===void 0?t:n;window.setTimeout(e,i)}}(),g={cssVenderPrefixes:["-moz","-webkit","-o","-ms"],cssCorders:["top-left","top-right","bottom-left","bottom-right"],cssBorderRadius:["border-top-left-radius","border-top-right-radius","border-bottom-left-radius","border-bottom-right-radius"],cssBoxDirs:["top","right","bottom","left"],cssBoxDirsLogical:["before","end","after","start"],cssBoxCornersLogical:["start-before","end-before","end-after","start-after"],css2dIndex:{1:[0,0],2:[0,1]},css4dIndex:{1:[0,0,0,0],2:[0,1,0,1],3:[0,1,2,1],4:[0,1,2,3]},space:"&nbsp;",clearFix:"<div style='clear:both'></div>"},d={toString:function(t){var e=[];for(var n in t)e.push(n+":"+p.escape(t[n]+""));return e.join(";")},addNehanPrefix:function(t){return"nehan-"+t},addNehanHeaderPrefix:function(t){return"nehan-header-"+t},addNehanTocLinkPrefix:function(t){return"nehan-toc-link-"+t}},p={escape:function(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#039;").replace(/"/g,"&quot;")},attr:function(t){var e=[];for(var n in t)t[n]&&e.push(n+"='"+this.escape(t[n]+"")+"'");return e==[]?"":e.join(" ")},tagWrap:function(t,e,n){return[this.tagStart(t,n||{}),e,this.tagEnd(t)].join("")},tagSingle:function(t,e){return"<"+t+" "+this.attr(e)+"/>"},tagStart:function(t,e){return"<"+t+" "+this.attr(e)+">"},tagEnd:function(t){return"</"+t+">"}},m={id:function(){return function(t){return t}},eq:function(t){return function(e){return t==e}},neq:function(t){return function(e){return t!=e}}},x={copy:function(t,e){for(var n in e)t[n]=e[n];return t},merge:function(t,e,n){for(var i in e)t[i]=n[i]===void 0?e[i]:n[i];return t}},k={PAGE_BREAK:2,LINE_BREAK:3,BUFFER_END:4,OVER_FLOW:5,RETRY:6,SKIP:7,BREAK:8,toString:function(t){for(var e in this)if(this[e]===t)return e;return"??"}},v=function(){var t=function(t){return l.trim(t+"").replace(/;/g,"").replace(/\n/g,"")},e=function(t){return 0>t.indexOf(" ")?[t]:t.split(/\s+/)},n=function(t){return 0>t.indexOf("/")?[t]:t.split("/")},i=function(t,e){var n={};if(t.length!==e.length)throw"invalid args:zip_obj";return o.iteri(t,function(t,i){n[i]=e[t]}),n},r=function(t){return g.css2dIndex[Math.min(t,2)]||[]},s=function(t){return g.css4dIndex[Math.min(t,4)]||[]},a=function(t,e){return o.map(e,function(e){return t[e]})},u=function(t){var e=r(t.length);return a(t,e)},h=function(t){var e=s(t.length);return a(t,e)},c=function(t){var e=g.cssBoxDirsLogical,n=h(t);return i(e,n)},f=function(t){var e=g.cssBoxCornersLogical,n=h(t);return i(e,n)},d=function(t){return c(e(t))},p=function(t){var i=u(n(t)),r=o.map(i,function(t){return h(e(t))}),s=o.zip(r[0],r[1]);return f(s)},m=function(t){var n=[],i=e(t),r=i.length;return r>=1&&n.push({"border-width":d(i[0])}),r>=2&&n.push({"border-style":d(i[1])}),r>=3&&n.push({"border-color":d(i[2])}),n},x=function(t){var n=[],i=e(t),r=i.length;return r>=1&&n.push({"list-style-type":d(i[0])}),r>=2&&n.push({"list-style-image":d(i[1])}),r>=3&&n.push({"list-style-position":d(i[2])}),n},k=function(){return{}},v=function(){return{}},b=function(e,n){if("function"==typeof n||"object"==typeof n)return n;switch(n=t(n),e){case"background":return v(n);case"border":return m(n);case"border-color":return d(n);case"border-radius":return p(n);case"border-style":return d(n);case"border-width":return d(n);case"font":return k(n);case"list-style":return x(n);case"margin":return d(n);case"padding":return d(n);default:return n}};return{format:function(t,e){try{return b(t,e)}catch(n){return{}}}}}(),b=function(){function t(t,e){this.key=this._createKey(t),this.rex=this._createRegExp(this.key),this.value=this._formatValue(e)}var e=function(t,e,i){i instanceof Array?n(t,i):t[e]=i},n=function(t,n){o.iter(n,function(n){for(var i in n)e(t,i,n[i])})};return t.prototype={getKey:function(){return this.key},getValue:function(){return this.value},test:function(t){return t=t.toLowerCase(),null===this.rex?this.key===t:this.rex.test(t)},hasClass:function(){return/\.[^\.\s]+/.test(this.key)},hasId:function(){return/#[^#\s]+/.test(this.key)},hasContext:function(){return/[\S]+\s+[\S]+/.test(this.key)},_formatValue:function(t){var n={};for(var i in t)e(n,i,v.format(i,t[i]));return n},_createKey:function(t){return l.trim(t).toLowerCase().replace(/\s+/g," ")},_createPattern:function(t){return t.replace(/([^\s#\^]*)#(\S+)/g,"$1#$2").replace(/([^\s\.\^]*)\.(\S+)/g,"$1\\.$2").replace(/\s/g,"(\\s|[a-z0-9-_=:\\[\\]])*")+"$"},_createRegExp:function(t){if(!this.hasId()&&!this.hasClass()&&!this.hasContext())return null;var e=this._createPattern(t);return RegExp(e)}},t}(),y=function(){var t=[];for(var e in s)t.push(new b(e,s[e]));return{setValue:function(e,n){s[e]?x.copy(s[e],n):(s[e]=n,t.push(new b(e,n)))},getValue:function(e){return o.fold(t,{},function(t,n){return n.test(e)?x.copy(t,n.getValue()):t})},getMergedValue:function(t){var e=this;return o.fold(t,{},function(t,n){return x.copy(t,e.getValue(n))})}}}(),C=function(){var t=function(t,e){for(var n=function(){return t.charAt(0)},i=function(e){t=t.substring(e)},r=function(e){var n=-1;return o.iter(e,function(e){var i=t.indexOf(e,1);(0>n||n>i)&&(n=i)}),n>=0?t.substring(0,n):t},s=function(e){var n=t.indexOf(e,1);return n>=1?t.substring(1,n):t},a=function(a){if(""===t)return a&&(e[a]=!0),void 0;var o,u=n();if(" "===u)i(1),arguments.callee(a);else if("="===u){if(i(1),t.length>0){var h=n();'"'===h||"'"===h?(o=s(h),i(o.length+2)):(o=r([" "]),i(o.length)),e[a]=o}}else a?e[a]=!0:(a=r([" ","="]),i(a.length),arguments.callee(a))};""!==t;)a();return e},e=function(t){return t.replace(/<[\S]+/,"").replace(/^\s+/,"").replace("/>","").replace(">","").replace(/\s+$/,"").replace(/\n/g,"").replace(/[　|\s]+/g," ").replace(/\s+=/g,"=").replace(/=\s+/g,"=")};return{parse:function(n){return n=e(n),t(n,{})}}}(),_=function(){function t(t,e){this._type="tag",this._inherited=!1,this.src=t,this.name=this._parseName(this.src),this.parent=null,this.contentRaw=e||"",this.dataset={},this.tagAttr={},this.cssAttrContext={},this.cssAttrDynamic={},this.childs=[],this.tagAttr=this._parseTagAttr(this.src),this.id=this._parseId(),this.classes=this._parseClasses(),this.selectors=this._parseSelectors(this.id,this.classes),this.cssAttrContext=this._parseCssAttr(this.selectors)}var e=/(^(<[^>]+>|[\s\n])*)(\S)/im,n={},r=function(t,e){n[t]=e},s=function(t){return n[t]||null};return t.prototype={inherit:function(t){if(!this._inherited){if(this.parent=t,this.parent.addChild(this),"body"!=t.getName()){var e=this.selectors.length,n=t.getSelectors(),i=this._parseContextSelectors(n);this.selectors=this.selectors.concat(i),this.selectors.length>e&&(this.cssAttrContext=this._parseCssAttr(this.selectors))}for(var r in this.cssAttrContext)"inherit"===this.cssAttrContext[r]&&this.setCssAttr(r,t.getAttr(r));this.fullSelectorCacheKey=this._getCssCacheKey(this.selectors),this._inherited=!0}},setContentRaw:function(t){this.contentRaw=t},setTagAttr:function(t,e){this.tagAttr[t]=e},setCssAttr:function(t,e){this.cssAttrDynamic[t]=e},setCssAttrs:function(t){for(var e in t)this.setCssAttr(e,t[e])},setFirstChild:function(){var t=this.getPseudoClassCssAttr("first-child");this.setCssAttrs(t)},setFirstLetter:function(){var t=this.getDataset("key"),e=s(t);e&&this.setCssAttrs(e)},addChild:function(t){this.childs.push(t)},addClass:function(t){this.classes.push(t)},removeClass:function(t){this.classes=o.filter(this.classes,function(e){return e!=t})},iterTagAttr:function(t){o.each(this.tagAttr,t)},iterCssAttrDynamic:function(t){o.each(this.cssAttrDynamic,t)},iterCssAttrContext:function(t){o.each(this.cssAttrContext,t)},iterCssAttr:function(t){this.iterCssAttrContext(t),this.iterCssAttrDynamic(t)},iterAttr:function(t){this.iterCssAttr(t),this.iterTagAttr(t)},getName:function(){return this.name},getAttr:function(t,e){return this.getTagAttr(t)||this.getCssAttr(t)||(e!==void 0?e:null)},getParent:function(){return this.parent||null},getChilds:function(){return this.childs},getParentChilds:function(){return this.parent?this.parent.getChilds():[]},getParentTypeChilds:function(){var t=this.getName();return o.filter(this.getParentChilds(),function(e){return e.getName()===t})},getOrder:function(){return this.order||-1},getPseudoClassCssAttr:function(t){var e=this._parsePseudoClassSelectors(t);return this._parseCssAttr(e)},getPseudoElementCssAttr:function(t){var e=this._parsePseudoElementSelectors(t);return this._parseCssAttr(e)},getSelectors:function(){return this.selectors},getCssClasses:function(){return this.classes.join(" ")},getTagAttr:function(t,e){return this.tagAttr[t]||(e!==void 0?e:null)},getCssAttr:function(t,e){return this.cssAttrDynamic[t]||this.cssAttrContext[t]||(e!==void 0?e:null)},getCssAttrs:function(t){return o.fold([this.cssAttrContext,this.cssAttrDynamic],[],function(e,n){return n[t]!==void 0&&e.push(n[t]),e})},getDataset:function(t,e){return this.dataset[t]||(e!==void 0?e:null)},getContentRaw:function(){return this.contentRaw},getContent:function(){return this.content?this.content:(this.content=this._parseContent(this.contentRaw),this.content)},getSrc:function(){return this.src},getLogicalFloat:function(){return this.getCssAttr("float","none")},getHeaderRank:function(){return this.getName().match(/h([1-6])/)?parseInt(RegExp.$1,10):0},getStaticSize:function(t,e){var n=this.getAttr("width"),r=this.getAttr("height");if(n&&r)return n=h.getBoxSize(n,t,e),r=h.getBoxSize(r,t,e),new se(n,r);if("img"===this.name){var s=i.fontSize;return new se(s,s)}return null},getBoxEdge:function(t,e){var n=this.getCssAttr("padding"),i=this.getCssAttr("margin"),r=this.getCssAttr("border-width"),s=this.getCssAttr("border-color"),a=this.getCssAttr("border-style"),o=this.getCssAttr("border-radius");if(null===n&&null===i&&null===r&&null===o)return null;var u=new ne;if(n){var l=h.getEdgeSize(n,e);u.setSize("padding",t,l)}if(i){var c=h.getEdgeSize(i,e);u.setSize("margin",t,c)}if(r){var f=h.getEdgeSize(r,e);u.setSize("border",t,f)}if(o){var g=h.getCornerSize(o,e);u.setBorderRadius(t,g)}return s&&u.setBorderColor(t,s),a&&u.setBorderStyle(t,a),u},hasStaticSize:function(){return null!==this.getAttr("width")&&null!==this.getAttr("height")},hasFlow:function(){return null!==this.getCssAttr("flow")},hasClass:function(t){return o.exists(this.classes,m.eq(t))},hasLayout:function(){var t=this.getName();return"br"!=t&&"page-break"!=t&&"end-page"!=t},isPseudoElement:function(){return"before"===this.name||"after"===this.name||"first-letter"===this.name||"first-line"===this.name},isClassAttrEnable:function(){return this.tagAttr["class"]!==void 0},isFloated:function(){return"none"!=this.getLogicalFloat()},isPush:function(){return this.tagAttr.push!==void 0},isPull:function(){return this.tagAttr.pull!==void 0},isClose:function(){return"/"===this.name.substring(0,1)},isAnchorTag:function(){return"a"===this.name&&null!==this.getTagAttr("name")},isAnchorLinkTag:function(){var t=this.getTagAttr("href");return"a"===this.name&&t&&t.indexOf("#")>=0},isEmbeddableTag:function(){return"true"===this.getCssAttr("embeddable")},isBlock:function(){return this.hasStaticSize()&&this.isFloated()?!0:this.isPush()||this.isPull()?!0:"block"===this.getCssAttr("display","inline")},isInline:function(){var t=this.getCssAttr("display","inline");return"inline"===t||"inline-block"===t},isInlineBlock:function(){return"inline-block"===this.getCssAttr("display","inline")},isSingleTag:function(){return"true"===this.getCssAttr("single")},isChildContentTag:function(){return this.isSingleTag()?!1:!0},isTcyTag:function(){return"horizontal"===this.getCssAttr("text-combine","")},isSectionRootTag:function(){return"true"===this.getCssAttr("section-root")},isSectionTag:function(){return"true"===this.getCssAttr("section")},isBoldTag:function(){var t=this.getName();return"b"===t||"strong"===t},isHeaderTag:function(){return this.getHeaderRank()>0},isPageBreakTag:function(){var t=this.getName();return"end-page"===t||"page-break"===t},_getChildIndexFrom:function(t){var e=this;return o.indexOf(t,function(t){return S.isSame(e,t)})},getChildNth:function(){return this._getChildIndexFrom(this.getParentChilds())},getLastChildNth:function(){return this._getChildIndexFrom(o.reverse(this.getParentChilds()))},getChildOfTypeNth:function(){return this._getChildIndexFrom(this.getParentTypeChilds())},getLastChildOfTypeNth:function(){return this._getChildIndexFrom(this.getParentTypeChilds())},isFirstChild:function(){return 0===this.getChildNth()},isLastChild:function(){var t=this.getParentChilds();return this.getChildNth()===t.length-1},isFirstOfType:function(){return 0===this.getChildOfTypeNth()},isLastOfType:function(){var t=this.getParentTypeChilds();return this.getChildOfTypeNth()===t.length-1},isOnlyChild:function(){return 1===this.getParentChilds().length},isOnlyOfType:function(){var t=this.getParentTypeChilds();return 1===t.length&&S.isSame(t[0],this)},isRoot:function(){return null===this.parent},isEmpty:function(){return""===this.getContent()},_getCssCacheKey:function(t){return t.join("*")},_getPseudoElementCssCacheKey:function(t){return[this.fullSelectorCacheKey,t].join("::")},_parseName:function(t){return t.replace(/</g,"").replace(/\/?>/g,"").split(/\s/)[0].toLowerCase()},_parseId:function(){return this.tagAttr.id||""},_parseClasses:function(){var t=this.tagAttr["class"]||"";return""===t?[]:t.split(/\s+/)},_parseCssClasses:function(t){return o.map(t,function(t){return"."+t})},_parseSelectors:function(t,e){var n=this.getName(),i=[n],r=o.map(e,function(t){return n+"."+t}),s=t?[n+"#"+t]:[];return i.concat(r).concat(s)},_parseContextSelectors:function(t){var e=this.selectors;return o.fold(t,[],function(t,n){return t.concat(o.fold(e,[],function(t,e){return t.concat([n+" "+e])}))})},_parsePseudoClassSelectors:function(t){return o.map(this.selectors,function(e){return e+":"+t})},_parsePseudoElementSelectors:function(t){return o.map(this.selectors,function(e){return e+"::"+t})},_parseCssAttr:function(t){var e=this._getCssCacheKey(t),n=s(e);return null===n&&(n=y.getMergedValue(t),r(e,n)),n},_parsePseudoElementContentSrc:function(t){var e=this.getPseudoElementCssAttr(t);if(u.isEmpty(e))return"";var n=this._getPseudoElementCssCacheKey(t);r(e);var i=e.content||"";return p.tagWrap(t,i,{"data-key":n})},_appendFirstLetter:function(t){var n=this.getPseudoElementCssAttr("first-letter");if(u.isEmpty(n))return t;var i=this._getPseudoElementCssCacheKey(this.selectors,"first-letter");return r(i,n),t.replace(e,function(t,e,n,r){return e+p.tagStart("first-letter",{"data-key":i})+r+"</first-letter>"})},_parseContent:function(t){var e=this._parsePseudoElementContentSrc("before"),n=this._parsePseudoElementContentSrc("after");return this._appendFirstLetter([e,t,n].join(""))},_parseTagAttr:function(){var t=C.parse(this.src);for(var e in t)if("style"===e){var n=this._parseInlineStyle(t[e]);x.copy(this.cssAttrDynamic,n)}else if(0===e.indexOf("data-")){var i=this._parseDatasetName(e);this.dataset[i]=t[e]}return t},_parseInlineStyle:function(t){var e={},n=t.indexOf(";")>=0?t.split(";"):[t];return o.iter(n,function(t){var n=t.split(":");if(n.length>=2){var i=l.trim(n[0]),r=l.trim(n[1]);e[i]=r}}),e},_parseDatasetName:function(t){var e=t.slice(5);return l.getCamelName(e)}},t}(),S={isSame:function(t,e){return t._gtid===e._gtid},isTag:function(t){return"tag"===t._type},isText:function(t){return"char"===t._type||"word"===t._type||"tcy"===t._type},isChar:function(t){return"char"===t._type},isWord:function(t){return"word"===t._type},isTcy:function(t){return"tcy"===t._type},isInline:function(t){return this.isText(t)?!0:t.isBlock()?!1:t.isInline()||t.isInlineBlock()}},w=function(){function t(t,e){this.data=t,this._type="char",this.isRef=e||!1,this.isRef||this._setup(t.charCodeAt(0))}var e=["。","."],s=["、",","],a=["｢","「","『","【","［","（","《","〈","≪","＜","｛","{","[","("],u=["」","｣","』","】","］","）","》","〉","≫","＞","｝","}","]",")"],h=["ぁ","ぃ","ぅ","ぇ","ぉ","っ","ゃ","ゅ","ょ","ゎ","ァ","ィ","ゥ","ェ","ォ","ヵ","ヶ","ッ","ャ","ュ","ョ","ヮ"],l=["）","\\",")","」","】","〕","］","\\","]","。","』","＞","〉","》","、","．","\\",".",",","”","〟"],c=["（","\\","(","「","【","［","〔","\\","[","『","＜","〈","《","“","〝"];return t.prototype={getCssPadding:function(t){var e=new Q;return this.paddingStart&&e.setStart(t.flow,this.paddingStart),this.paddingEnd&&e.setEnd(t.flow,this.paddingEnd),e.getCss()},getCssVertGlyph:function(){var t={},e=this.isPaddingEnable();return t["-webkit-writing-mode"]="vertical-rl",t["margin-left"]="auto",t["margin-right"]="auto",this.isKakkoStart()?e||(t["margin-top"]="-0.5em"):(1>this.getVertScale()&&(t.height="0.5em"),e&&(t["margin-bottom"]="0.5em")),t},getCssVertImgChar:function(t){var e={};return e.display="block",e.width=t.fontSize+"px",e.height=this.getVertHeight(t.fontSize)+"px",e["margin-left"]="auto",e["margin-right"]="auto",this.isPaddingEnable()&&x.copy(e,this.getCssPadding(t)),e},getCssVertEmphaSrc:function(){var t={};return t},getCssVertEmphaText:function(t){var e={};return e.display="inline-block",e.width=t.fontSize+"px",e.height=t.fontSize+"px",e},getCssHoriEmphaSrc:function(){var t={};return t},getCssHoriEmphaText:function(){var t={};return t["margin-bottom"]="-0.5em",t},getCssVertLetterSpacing:function(t){var e={};return e["margin-bottom"]=t.letterSpacing+"px",e},getCssVertHalfSpaceChar:function(t){var e={},n=Math.floor(t.fontSize/2);return e.height=n+"px",e["line-height"]=n+"px",e},getCssVertSmallKana:function(){var t={};return t.position="relative",t.top="-0.1em",t.right="-0.12em",t.height=this.bodySize+"px",t["line-height"]=this.bodySize+"px",t
},getHoriScale:function(){return this.hscale?this.hscale:1},getVertScale:function(){return this.vscale?this.vscale:1},getVertHeight:function(t){var e=this.getVertScale();return 1===e?t:Math.floor(t*e)},hasMetrics:function(){return this.bodySize!==void 0},getAdvance:function(t,e){return this.bodySize+this.getPaddingSize()+e},getPaddingSize:function(){return(this.paddingStart||0)+(this.paddingEnd||0)},getCharCount:function(){return" "===this.data||"	"===this.data||"　"===this.data?0:1},setMetrics:function(t,e){var n=t.isTextVertical(),i=n?this.getVertScale():this.getHoriScale();this.bodySize=1!=i?Math.floor(e*i):e,this.spaceRateStart&&(this.paddingStart=Math.floor(this.spaceRateStart*e)),this.spaceRateEnd&&(this.paddingEnd=Math.floor(this.spaceRateEnd*e)),this.img&&"tenten"===this.img&&(this.bodySize=e),n||this.isRef||!this.isHankaku()||(this.bodySize=Math.floor(e/2))},_setImg:function(t,e,n){this.img=t,this.vscale=e||1,this.hscale=n||this.vscale},_setCnv:function(t,e,n){this.cnv=t,this.vscale=e||1,this.hscale=n||this.vscale},_setup:function(t){switch(t){case 32:this._setCnv("&nbsp;",.5,.5);break;case 12300:this._setImg("kakko1",.5);break;case 65378:this._setImg("kakko1",.5);break;case 12301:this._setImg("kakko2",.5);break;case 65379:this._setImg("kakko2",.5);break;case 12302:this._setImg("kakko3",.5);break;case 12303:this._setImg("kakko4",.5);break;case 65288:this._setImg("kakko5",.5);break;case 40:this._setImg("kakko5",.5);break;case 65371:this._setImg("kakko5",.5);break;case 123:this._setImg("kakko5",.5);break;case 65289:this._setImg("kakko6",.5);break;case 41:this._setImg("kakko6",.5);break;case 65373:this._setImg("kakko6",.5);break;case 125:this._setImg("kakko6",.5);break;case 65308:this._setImg("kakko7",.5);break;case 60:this._setImg("kakko7",.5);break;case 12296:this._setImg("kakko7",.5);break;case 65310:this._setImg("kakko8",.5);break;case 62:this._setImg("kakko8",.5);break;case 12297:this._setImg("kakko8",.5);break;case 12298:this._setImg("kakko9",.5);break;case 8810:this._setImg("kakko9",.5);break;case 12299:this._setImg("kakko10",.5);break;case 8811:this._setImg("kakko10",.5);break;case 65339:this._setImg("kakko11",.5);break;case 12308:this._setImg("kakko11",.5);break;case 91:this._setImg("kakko11",.5);break;case 65341:this._setImg("kakko12",.5);break;case 12309:this._setImg("kakko12",.5);break;case 93:this._setImg("kakko12",.5);break;case 12304:this._setImg("kakko17",.5);break;case 12305:this._setImg("kakko18",.5);break;case 65306:this._setImg("tenten",.5,1);break;case 58:this._setImg("tenten",.5,1);break;case 12290:this._setImg("kuten",.5);break;case 65377:this._setImg("kuten",.5);break;case 65294:this._setImg("period",1);break;case 46:this._setImg("period",1);break;case 12289:this._setImg("touten",.5);break;case 65380:this._setImg("touten",.5);break;case 44:this._setImg("touten",.5);break;case 65292:this._setImg("touten",.5);break;case 65374:this._setImg("kara",1);break;case 12316:this._setImg("kara",1);break;case 8230:this._setImg("mmm",1);break;case 8229:this._setImg("mm",1);break;case 12317:this._setImg("dmn1",1);break;case 12319:this._setImg("dmn2",1);break;case 65309:this._setImg("equal",1);break;case 61:this._setImg("equal",1);break;case 12540:this._setImg("onbiki",1);break;case 45:this._setCnv("&#65372;");break;case 8213:this._setCnv("&#65372;");break;case 65293:this._setCnv("&#65372;");break;case 9472:this._setCnv("&#65372;");break;case 8593:this._setCnv("&#8594;");break;case 8594:this._setCnv("&#8595;");break;case 8658:this._setCnv("&#8595;");break;case 8595:this._setCnv("&#8592;");break;case 8592:this._setCnv("&#8593;")}},isNewLineChar:function(){return"\n"===this.data},isImgChar:function(){return this.img!==void 0},isCnvChar:function(){return this.cnv!==void 0},isCharRef:function(){return this.isRef},isHalfSpaceChar:function(){return this.isCnvChar()&&"&nbsp;"===this.cnv},isKerningChar:function(){return this.isKutenTouten()||this.isKakko()},getImgSrc:function(t){return[i.fontImgRoot,this.img,t+".png"].join("/")},isPaddingEnable:function(){return this.paddingStart!==void 0||this.paddingEnd!==void 0},isVertGlyphEnable:function(){return!this.isTenten()&&n.useVerticalGlyphIfEnable&&r.isVerticalGlyphEnable},isTenten:function(){return this.img&&"tenten"===this.img},isHeadNg:function(){return o.mem(l,this.data)},isTailNg:function(){return o.mem(c,this.data)},isSmallKana:function(){return o.mem(h,this.data)},isKakkoStart:function(){return o.mem(a,this.data)},isKakkoEnd:function(){return o.mem(u,this.data)},isKakko:function(){return this.isKakkoStart()||this.isKakkoEnd()},isKuten:function(){return o.mem(e,this.data)},isTouten:function(){return o.mem(s,this.data)},isKutenTouten:function(){return this.isKuten()||this.isTouten()},isZenkaku:function(){return"u"===escape(this.data).charAt(1)},isHankaku:function(){return!this.isZenkaku(this.data)}},t}(),T=function(){function t(t,e){this.data=t,this._type="word",this._devided=e||!1}return t.prototype={getCssVertTrans:function(t){var e={};return e["letter-spacing"]=t.letterSpacing+"px",e.width=t.fontSize+"px",e.height=this.bodySize+"px",e["margin-left"]=e["margin-right"]="auto",e},getCssVertTransIE:function(t){var e={};return e["float"]="left",e["writing-mode"]="tb-rl",e["letter-spacing"]=t.letterSpacing+"px",e["line-height"]=t.fontSize+"px",e},getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+e*this.getLetterCount()},hasMetrics:function(){return this.bodySize!==void 0},setMetrics:function(t,e,n){if(this.bodySize=this.data.length*Math.floor(e/2),n){var r=i.boldRate;this.bodySize+=Math.floor(r*this.bodySize)}},getLetterCount:function(){return this.data.length},setDevided:function(t){this._devided=t},isDevided:function(){return this._devided},cutMeasure:function(e,n){var i=Math.floor(e/2),r=Math.floor(this.bodySize/i),s=Math.floor(n/i);if(s>=r)return this;var a=this.data.substring(0,s),o=new t(a,!0);return this.data=this.data.slice(s),this.setDevided(!0),o}},t}(),E=function(){function t(t){this.data=t,this._type="tcy"}return t.prototype={getCharCount:function(){return 1},getAdvance:function(t,e){return this.bodySize+e},hasMetrics:function(){return this.bodySize!==void 0},setMetrics:function(t,e){this.bodySize=e}},t}(),B=function(){function t(t,e){this._type="ruby",this.rbs=t,this.rt=e,this.padding=new Q}return t.prototype={hasMetrics:function(){return this.advanceSize!==void 0},getAdvance:function(){return this.advanceSize},getExtent:function(t){return 3*this.rubyFontSize+t},getRbs:function(){return this.rbs},getRtString:function(){return this.rt?this.rt.getContent():""},getRtFontSize:function(){return this.rubyFontSize},getCssVertRuby:function(t){var e={};return e["margin-left"]=Math.floor((t.maxExtent-t.fontSize)/2)+"px",e[t.flow.getPropExtent()]=this.getExtent(t.fontSize)+"px",e[t.flow.getPropMeasure()]=this.getAdvance()+"px",e},getCssHoriRuby:function(){var t={};return t.display="inline-block",t},getCssVertRt:function(){var t={};return t["float"]="left",t},getCssHoriRt:function(){var t={};return t["font-size"]=t["line-height"]=this.getRtFontSize()+"px",t["vertical-align"]="bottom",t},getCssVertRb:function(){var t={};return t["float"]="left",x.copy(t,this.padding.getCss()),t},getCssHoriRb:function(){var t={};return x.copy(t,this.padding.getCss()),t["text-align"]="center",t},setMetrics:function(t,e,n){this.rubyFontSize=i.getRubyFontSize(e);var r=o.fold(this.rbs,0,function(i,r){return r.setMetrics(t,e),i+r.getAdvance(t,n)}),s=this.rubyFontSize*this.getRtString().length;if(this.advanceSize=r,s>r){var a=Math.ceil((s-r)/2);this.rbs.length>0&&(this.padding.setStart(t,a),this.padding.setEnd(t,a)),this.advanceSize+=a+a}}},t}(),z=function(){function t(t){this.value=t+"",this.red=parseInt(this.value.substring(0,2),16),this.green=parseInt(this.value.substring(2,4),16),this.blue=parseInt(this.value.substring(4,6),16)}return t.prototype={getRed:function(){return this.red},getGreen:function(){return this.green},getBlue:function(){return this.blue},getColorValue:function(){return this.value}},t}(),P=function(){function t(t){this.setValue(t)}return t.prototype={setValue:function(t){this.value=I.get(t)},getValue:function(){return this.value},getCssValue:function(){return"transparent"===this.value?this.value:"#"+this.value},getRgb:function(){return new z(this.value)},getCss:function(){var t={};return t.color=this.getCssValue(),t}},t}(),I=function(){var t={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4","indianred ":"cd5c5c","indigo ":"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32",transparent:"transparent"},e=/^(?:[0-9a-f]{3}){1,2}$/;return{get:function(n){return n=n.replace(/#/g,"").toLowerCase(),e.test(n)?3===n.length?n[0]+n[0]+n[1]+n[1]+n[2]+n[2]:n:t[n]||n}}}(),N=function(){var t=[0,36,73,109,146,182,219,255],e=[0,85,170,255],n=function(t){var e=t.toString(16);return 1>=e.length?"0"+e:e},i=function(t,e){return o.exists(e,m.eq(t))?t:o.minobj(e,function(e){return Math.abs(e-t)})};return{getColor:function(r){var s=i(r.getRed(),t),a=i(r.getGreen(),t),o=i(r.getBlue(),e);return[n(s),n(a),n(o)].join("")}}}(),A=function(){var t={"lower-alpha":["a","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z"],"upper-alpha":["A","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],"lower-roman":["i","i","ii","iii","iv","v","vi","vii","viii","ix","x","xi","xii","xiii","xiv","xv","xvi","xvii","xviii","xix","xx"],"upper-roman":["I","I","II","III","IV","V","VI","VII","VIII","IX","X","XI","XII","XIII","XIV","XV","XVI","XVII","XVIII","XIX","XX"],"lower-greek":["α","α","β","γ","δ","ε","ζ","η","θ","ι","κ","λ","μ","ν","ξ","ο","π","ρ","σ","τ","υ","φ","χ","ψ","ω"],"upper-greek":["Α","Α","Β","Γ","Δ","Ε","Ζ","Η","Θ","Ι","Κ","Λ","Μ","Ν","Ξ","Ο","Π","Ρ","Σ","Τ","Υ","Φ","Χ","Ψ","Ω"],"cjk-ideographic":["〇","一","二","三","四","五","六","七","八","九","十"],hiragana:["あ","あ","い","う","え","お","か","き","く","け","こ","さ","し","す","せ","そ","た","ち","つ","て","と","な","に","ぬ","ね","の","は","ひ","ふ","へ","ほ","ま","み","む","め","も","や","ゆ","よ","ら","り","る","れ","ろ","わ","ゐ","ゑ","を","ん"],"hiragana-iroha":["い","い","ろ","は","に","ほ","へ","と","ち","り","ぬ","る","を","わ","か","よ","た","れ","そ","つ","ね","な","ら","む","う","ゐ","の","お","く","や","ま","け","ふ","こ","え","て","あ","さ","き","ゆ","め","み","し","ゑ","ひ","も","せ","す"],katakana:["ア","ア","イ","ウ","エ","オ","カ","キ","ク","ケ","コ","サ","シ","ス","セ","ソ","タ","チ","ツ","テ","ト","ナ","ニ","ヌ","ネ","ノ","ハ","ヒ","フ","ヘ","ホ","マ","ミ","ム","メ","モ","ヤ","ユ","ヨ","ラ","リ","ル","レ","ロ","ワ","ヰ","ヱ","ヲ","ン"],"katakana-iroha":["イ","イ","ロ","ハ","ニ","ホ","ヘ","ト","チ","リ","ヌ","ル","ヲ","ワ","カ","ヨ","タ","レ","ソ","ツ","ネ","ナ","ラ","ム","ウ","ヰ","ノ","オ","ク","ヤ","マ","ケ","フ","コ","エ","テ","ア","サ","キ","ユ","メ","ミ","シ","ヱ","ヒ","モ","セ","ス"]},e={"upper-latin":"upper-alpha","lower-latin":"lower-alpha"};return{getTableByName:function(n){return t[e[n]||n]},getBaseByName:function(t){var e=this.getTableByName(t);return e.length},getStringByName:function(t,e){for(var n=this.getTableByName(t),i=n.length,r=c.convBase(e,i),s="",a=0;r.length>a;a++){var o=r[a],u=0===a?r[a]:Math.min(o+1,i-1);s+=n[u]||""}return s}}}(),M=function(){function t(t){this.type=t}var e={disc:"&#x2022;",circle:"&#x25CB;",square:"&#x25A0;"};return t.prototype={isDecimalList:function(){return"decimal"===this.type||"decimal-leading-zero"===this.type},isNoneList:function(){return"none"===this.type},isMarkList:function(){return"disc"===this.type||"circle"===this.type||"square"===this.type},isCountableList:function(){return!this.isNoneList()&&!this.isMarkList()},isHankaku:function(){return"lower-alpha"===this.type||"upper-alpha"===this.type||"lower-roman"===this.type||"upper-roman"===this.type||this.isDecimalList()},isZenkaku:function(){return!this.isHankaku()},_getMarkerDigitString:function(t){return"decimal"===this.type?t.toString(10):"decimal-leading-zero"===this.type?10>t?"0"+t.toString(10):t.toString(10):A.getStringByName(this.type,t)},getMarkerHtml:function(t){var e=this.getMarkerText(t);return this.isZenkaku()?p.tagWrap("span",e,{"class":"nehan-tcy"}):e},getMarkerText:function(t){if(this.isNoneList())return g.space;if(this.isMarkList())return e[this.type]||"";var n=this._getMarkerDigitString(t);return n+"."},getMarkerAdvance:function(t,e,n){var r=Math.floor(e/2),s=r,a=i.getListMarkerSpacingSize(e),o=this.isZenkaku()?e:r,u=this.getMarkerText(n);return this.isNoneList()?e:this.isMarkList()?e+a:this.isZenkaku()&&t.isTextVertical()?e+a:(u.length-1)*o+s+a}},t}(),R=function(){function t(t){this.pos=t}return t.prototype={isOutside:function(){return"outside"===this.pos},isInside:function(){return"inside"===this.pos}},t}(),L=function(){function t(t){this.image=t}return t.prototype={getMarkerAdvance:function(t,e){var n=this.image[t.getPropMeasure()]||e,r=i.getListMarkerSpacingSize(e);return n+r},getMarkerHtml:function(){var t=this.image.url,e=this.image.width||i.fontSize,n=this.image.height||i.fontSize;return p.tagSingle("img",{src:t,"class":"nehan-list-image",width:e,height:n})}},t}(),F=function(){function t(t){this.type=new M(t.type||"none"),this.position=new R(t.position||"outside"),this.image="none"!==t.image?new L(t.image):null,this.format=t.format||null}return t.prototype={isMultiCol:function(){return this.position.isOutside()},isInside:function(){return this.position.isInside()},isImageList:function(){return null!==this.image},getMarkerHtml:function(t){return null!==this.format?"function"==typeof this.format?this.format(t):this.format:null!==this.image?this.image.getMarkerHtml(t):this.type.getMarkerHtml(t)},getMarkerAdvance:function(t,e,n){return this.image?this.image.getMarkerAdvance(t,e):this.type.getMarkerAdvance(t,e,n)}},t}(),H=a.extend({init:function(t){this.dir=t},isValid:function(){return"lr"===this.dir||"rl"===this.dir||"tb"===this.dir},isHorizontal:function(){return"lr"===this.dir||"rl"===this.dir},isVertical:function(){return"tb"===this.dir},isLeftToRight:function(){return"lr"===this.dir},isRightToLeft:function(){return"rl"===this.dir},reverse:function(){switch(this.dir){case"lr":return"rl";case"rl":return"lr";case"tb":return"tb";default:return""}}}),V=H.extend({init:function(t,e){this._super(t),this.multicol=e||!1},flip:function(){switch(this.dir){case"lr":case"rl":return"tb";case"tb":return i.getVertBlockdir();default:return""}},getCss:function(){var t={};return this.isHorizontal()?t["float"]="lr"===this.dir?"left":"right":this.isVertical()&&this.multicol&&(t["float"]="lr"===i.getHoriIndir()?"left":"right"),t},getPropBefore:function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},getPropAfter:function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}}}),W=H.extend({init:function(t){this._super(t)},getPropStart:function(){switch(this.dir){case"lr":return"left";case"rl":return"right";case"tb":return"top";default:return""}},getPropEnd:function(){switch(this.dir){case"lr":return"right";case"rl":return"left";case"tb":return"bottom";default:return""}}}),O=function(){function t(t,e,n){this.inflow=new W(t),this.blockflow=new V(e,n)}return t.prototype={getCss:function(){var t={};return x.copy(t,this.blockflow.getCss()),t},getName:function(){return[this.inflow.dir,this.blockflow.dir].join("-")},isValid:function(){return this.inflow.isValid()&&this.blockflow.isValid()},isTextLineFirst:function(){return this.isTextVertical()&&this.blockflow.isLeftToRight()?!0:!1},isBlockflowVertical:function(){return this.blockflow.isVertical()},isTextVertical:function(){return this.inflow.isVertical()},isTextHorizontal:function(){return this.inflow.isHorizontal()},getTextHorizontalDir:function(){return this.isTextHorizontal()?this.inflow.dir:""},getProp:function(t){switch(t){case"start":return this.getPropStart();case"end":return this.getPropEnd();case"before":return this.getPropBefore();case"after":return this.getPropAfter()}},getPropStart:function(){return this.inflow.getPropStart()},getPropEnd:function(){return this.inflow.getPropEnd()},getPropBefore:function(){return this.blockflow.getPropBefore()},getPropAfter:function(){return this.blockflow.getPropAfter()},getPropExtent:function(){return this.isTextVertical()?"width":"height"},getPropMeasure:function(){return this.isTextVertical()?"height":"width"},getPropWidth:function(){return this.isTextVertical()?"extent":"measure"},getPropHeight:function(){return this.isTextVertical()?"measure":"extent"},getParallelFlipFlow:function(){return G.get(this.inflow.dir,this.blockflow.dir,!1)},getParallelFlow:function(){return G.get(this.inflow.dir,this.blockflow.dir,!0)},getFlipFlow:function(){return this.isTextVertical()?i.getStdHoriFlow():i.getStdVertFlow()},getFloatedWrapFlow:function(){return this.isTextVertical()?this:this.getParallelFlow()},getBoxSize:function(t,e){var n=new se(0,0);return n[this.getPropMeasure()]=t,n[this.getPropExtent()]=e,n}},t}(),G={"tb-rl":new O("tb","rl"),"tb-lr":new O("tb","lr"),"lr-tb":new O("lr","tb"),"rl-tb":new O("rl","tb"),"tb-rl-mc":new O("tb","rl",!0),"tb-lr-mc":new O("tb","lr",!0),"lr-tb-mc":new O("lr","tb",!0),"rl-tb-mc":new O("rl","tb",!0),NORMAL:new O("lr","tb"),get:function(t,e,n){var i=n||!1,r=t+"-"+e+(i?"-mc":"");return this.getByName(r)},getByName:function(t){return this[t]}},D={iter:function(t,e){o.iter(g.cssBoxDirs,function(n){t[n]&&e(n,t[n])})},map:function(t,e){return t instanceof Array?o.map(t,e):"object"==typeof t?u.map(t,e):e(t)},setValue:function(t,e,n){return n.start!==void 0&&this.setStart(t,e,n.start),n.end!==void 0&&this.setEnd(t,e,n.end),n.before!==void 0&&this.setBefore(t,e,n.before),n.after!==void 0&&this.setAfter(t,e,n.after),t},setBefore:function(t,e,n){t[e.getPropBefore()]=n},setAfter:function(t,e,n){t[e.getPropAfter()]=n},setStart:function(t,e,n){t[e.getPropStart()]=n},setEnd:function(t,e,n){t[e.getPropEnd()]=n}},K={sortCornerDirection:function(t,e){var n={top:0,bottom:1,left:2,right:3};return[t,e].sort(function(t,e){return n[t]-n[e]})},getCornerName:function(t,e){var n=this.sortCornerDirection(t,e);return[n[0],l.capitalize(n[1])].join("")}},j=function(){function t(t){this.value=t||"margin-box"}return t.prototype={isContentBox:function(){return"content-box"===this.value},isMarginBox:function(){return"margin-box"===this.value},isBorderBox:function(){return"border-box"===this.value},containPadding:function(){return this.isBorderBox()},containBorder:function(){return this.isBorderBox()},containMargin:function(){return this.isMarginBox()},getCss:function(){var t={};return t["box-sizing"]="content-box",t}},t}(),q={"content-box":new j("content-box"),"border-box":new j("border-box"),"margin-box":new j("margin-box"),getByName:function(t){return this[t]||this["margin-box"]}},U=function(){function t(t){this.value=t}return t.prototype={isBold:function(){return"normal"!==this.value&&"lighter"!==this.value},getCss:function(){var t={};return t["font-weight"]=this.value,t}},t}(),$=a.extend({init:function(t){this._type=t,this.top=0,this.right=0,this.bottom=0,this.left=0},clear:function(){this.top=0,this.right=0,this.bottom=0,this.left=0},isEnable:function(){return 0!==this.top||0!==this.right||0!==this.bottom||0!==this.left},getDirProp:function(t){return[this._type,t].join("-")},getCss:function(){var t={},e=this;return o.iter(["top","right","bottom","left"],function(n){var i=e[n];i>0&&(t[e.getDirProp(n)]=e[n]+"px")}),t},getWidth:function(){return this.left+this.right},getHeight:function(){return this.top+this.bottom},getMeasureSize:function(t){return t.isTextVertical()?this.getHeight():this.getWidth()},getExtentSize:function(t){return t.isBlockflowVertical()?this.getHeight():this.getWidth()},setSize:function(t,e){D.setValue(this,t,e)},setStart:function(t,e){this[t.getPropStart()]=e},setEnd:function(t,e){this[t.getPropEnd()]=e},setBefore:function(t,e){this[t.getPropBefore()]=e},setAfter:function(t,e){this[t.getPropAfter()]=e},getStart:function(t){return this[t.getPropStart()]},getEnd:function(t){return this[t.getPropEnd()]},getBefore:function(t){return this[t.getPropBefore()]},getAfter:function(t){return this[t.getPropAfter()]},getLogicalSize:function(t,e){return this[t.getProp(e)]},setLogicalSize:function(t,e,n){this[t.getProp(e)]=n}}),X=function(){function t(){this.hori=0,this.vert=0}return t.prototype={setSize:function(t){this.hori=t[0],this.vert=t[1]},getCssValueHori:function(){return this.hori+"px"},getCssValueVert:function(){return this.vert+"px"}},t}(),Z=function(){function t(){this.topLeft=new X,this.topRight=new X,this.bottomRight=new X,this.bottomLeft=new X}return t.prototype={getArray:function(){return[this.topLeft,this.topRight,this.bottomRight,this.bottomLeft]},getCssValueHori:function(){return o.map(this.getArray(),function(t){return t.getCssValueHori()}).join(" ")},getCssValueVert:function(){return o.map(this.getArray(),function(t){return t.getCssValueVert()}).join(" ")},getCssValue:function(){return[this.getCssValueHori(),this.getCssValueVert()].join("/")},getCss:function(){var t={},e=this.getCssValue();return t["border-radius"]=e,o.iter(g.cssVenderPrefixes,function(n){var i=[n,"border-radius"].join("-");t[i]=e}),t},getCorner:function(t,e){var n=K.getCornerName(t,e);return this[n]},setSize:function(t,e){e["start-before"]!==void 0&&this.setStartBefore(t,e["start-before"]),e["start-after"]!==void 0&&this.setStartAfter(t,e["start-after"]),e["end-before"]!==void 0&&this.setEndBefore(t,e["end-before"]),e["end-after"]!==void 0&&this.setEndAfter(t,e["end-after"])},setStartBefore:function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropBefore());n.setSize(e)},setStartAfter:function(t,e){var n=this.getCorner(t.getPropStart(),t.getPropAfter());n.setSize(e)},setEndBefore:function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropBefore());n.setSize(e)},setEndAfter:function(t,e){var n=this.getCorner(t.getPropEnd(),t.getPropAfter());n.setSize(e)},clearBefore:function(t){this.setStartBefore(t,[0,0]),this.setEndBefore(t,[0,0])},clearAfter:function(t){this.setStartAfter(t,[0,0]),this.setEndAfter(t,[0,0])}},t}(),Y=function(){function t(){}return t.prototype={setColor:function(t,e){var n=this;D.setValue(this,t,e),D.iter(this,function(t,e){n[t]=new P(e)})},getCss:function(){var t={};return D.iter(this,function(e,n){var i=["border",e,"color"].join("-");t[i]=n.getCssValue()}),t}},t}(),J=function(){function t(){}return t.prototype={setStyle:function(t,e){D.setValue(this,t,e)},getCss:function(){var t={};return D.iter(this,function(e,n){var i=["border",e,"style"].join("-");t[i]=n}),t}},t}(),Q=$.extend({init:function(){this._super("padding")}}),te=$.extend({init:function(){this._super("margin")}}),ee=$.extend({init:function(){this._super("border")},clearBefore:function(t){this.setBefore(t,0),this.radius&&this.radius.clearBefore(t)},clearAfter:function(t){this.setAfter(t,0),this.radius&&this.radius.clearAfter(t)},getDirProp:function(t){return["border",t,"width"].join("-")},setRadius:function(t,e){this.radius=new Z,this.radius.setSize(t,e)},setColor:function(t,e){this.color=new Y,this.color.setColor(t,e)},setStyle:function(t,e){this.style=new J,this.style.setStyle(t,e)},getCss:function(){var t=this._super();return this.radius&&x.copy(t,this.radius.getCss()),this.color&&x.copy(t,this.color.getCss()),this.style&&x.copy(t,this.style.getCss()),t}}),ne=function(){function t(){this.padding=new Q,this.margin=new te,this.border=new ee}return t.prototype={isEnable:function(){return this.padding.isEnable()||this.margin.isEnable()||this.border.isEnable()},clear:function(){this.padding.clear(),this.margin.clear(),this.border.clear()},getCss:function(){var t={};return x.copy(t,this.padding.getCss()),x.copy(t,this.margin.getCss()),x.copy(t,this.border.getCss()),t},getWidth:function(){var t=0;return t+=this.padding.getWidth(),t+=this.margin.getWidth(),t+=this.border.getWidth()},getHeight:function(){var t=0;return t+=this.padding.getHeight(),t+=this.margin.getHeight(),t+=this.border.getHeight()},getMeasureSize:function(t){var e=0;return e+=this.padding.getMeasureSize(t),e+=this.margin.getMeasureSize(t),e+=this.border.getMeasureSize(t)},getExtentSize:function(t){var e=0;return e+=this.padding.getExtentSize(t),e+=this.margin.getExtentSize(t),e+=this.border.getExtentSize(t)},setAll:function(t,e,n){this[t].setAll(e,n)},setSize:function(t,e,n){this[t].setSize(e,n)},setEdgeSize:function(t,e){for(var n in e)this.setSize(n,t,e[n])},setEdgeStart:function(t,e,n){this[t].setStart(e,n)},setEdgeEnd:function(t,e,n){this[t].setEnd(e,n)},setEdgeBefore:function(t,e,n){this[t].setBefore(e,n)},setEdgeAfter:function(t,e,n){this[t].setAfter(e,n)},setBorderRadius:function(t,e){this.border.setRadius(t,e)},setBorderColor:function(t,e){this.border.setColor(t,e)},setBorderStyle:function(t,e){this.border.setStyle(t,e)},clearBorderStart:function(t){this.border.clearStart(t)},clearBorderBefore:function(t){this.border.clearBefore(t)},clearBorderAfter:function(t){this.border.clearAfter(t)}},t}(),ie=function(){function t(t,e){switch(arguments.length){case 1:this.parts=t;break;case 2:this.parts=this._mapSize(t,e)}}return t.prototype={getLength:function(){return this.parts.length},getSize:function(t){return this.parts[t]||null},_mapSize:function(t,e){var n=o.filter(t,function(t){return 0===t}),i=n.length;if(0===i)return t;var r=o.sum(t),s=e-r,a=Math.floor(s/i);return o.map(t,function(t){return t?t:a})}},t}(),re=function(){function t(){this.entry={}}return t.prototype={add:function(t){var e=t.getLength();this.entry[e]=t},getPartition:function(t){return this.entry[t]||null}},t}(),se=function(){function t(t,e){this.width=t,this.height=e}return t.prototype={isValid:function(){return this.width>0&&this.height>0},canInclude:function(t){return t.width<=this.width&&t.height<=this.height},getCss:function(){var t={};return t.width=this.width+"px",t.height=this.height+"px",t},getWhSlope:function(){return this.height/this.width},getHwSlope:function(){return this.width/this.height},getMeasure:function(t){return this[t.getPropMeasure()]},getExtent:function(t){return this[t.getPropExtent()]},setExtent:function(t,e){this[t.getPropExtent()]=e},setMeasure:function(t,e){this[t.getPropMeasure()]=e},subEdge:function(t){var e=t.getWidth(),n=t.getHeight();this.width=Math.max(0,this.width-e),this.height=Math.max(0,this.height-n)},subMeasure:function(t,e){var n=t.getPropMeasure();this[n]=Math.max(0,this[n]-e)},addMeasure:function(t,e){this[t.getPropMeasure()]+=e},addExtent:function(t,e){this[t.getPropExtent()]+=e},percentFrom:function(t){return Math.floor(100*this.width/t.width)},resizeWithin:function(t,e){var n=e.getMeasure(t),i=e.getExtent(t),r=this.getMeasure(t),s=this.getExtent(t);if(s>i&&(r=r*i/s,s=i),r>n){var a=s/r,o=r-n;s=Math.floor(s-a*o),r=n}return t.getBoxSize(r,s)},toLogicalSize:function(t){return new he(this.getMeasure(t),this.getExtent(t))}},t}(),ae=function(){function t(t){this.value=t||"dot filled"}var e={"dot filled":"&#x2022;","dot open":"&#x25e6;","circle filled":"&#x25cf;","circle open":"&#x25cb;","double-circle filled":"&#x25c9;","double-circle open":"&#x25ce;","triangle filled":"&#x25b2;","triangle open":"&#x25b3;","sesame filled":"&#xfe45;","sesame open":"&#xfe46;"};return t.prototype={setValue:function(t){this.value=t},getText:function(){return e[this.value]||this.value||e["dot filled"]},getCss:function(){var t={};return t}},t}(),oe=function(){function t(t){this.value=t||"over"}return t.prototype={isEmphaFirst:function(){return"over"===this.value||"left"===this.value||"before"===this.value},setValue:function(t){this.value=t},getCss:function(){var t={};return t}},t}(),ue=function(){function t(){this.pos=new oe,this.style=new ae,this.color=new P(i.fontColor)}return t.prototype={setPos:function(t){this.pos.setValue(t)},setStyle:function(t){this.style.setValue(t)},setColor:function(t){this.color.setValue(t)},getText:function(){return this.style.getText()},getExtent:function(t){return 3*t},getCssVertEmphaWrap:function(t,e){var n={};return n["padding-left"]="0.5em",n.width=this.getExtent(t.fontSize)+"px",n.height=e.getAdvance(t.fontSize,t.letterSpacing)+"px",n},getCssHoriEmphaWrap:function(t,e){var n={};return n.display="inline-block",n["padding-top"]=-t.fontSize+"px",n.width=e.getAdvance(t.fontSize,t.letterSpacing)+"px",n.height=this.getExtent(t.fontSize)+"px",n}},t}(),he=function(){function t(t,e){this.measure=t,this.extent=e}return t.prototype={canInclude:function(t){return t.measure<=this.measure&&t.extent<=this.extent},getWidth:function(t){return this[t.getPropWidth()]},getHeight:function(t){return this[t.getPropHeight()]},toBoxSize:function(t){return new se(this.getWidth(t),this.getHeight(t))}},t}(),le=function(){function t(){this.forward=[],this.normal=[],this.backward=[]}return t.prototype={get:function(){return this.forward.concat(this.normal).concat(this.backward)},setNormal:function(t){this.normal=t},getLength:function(){return this.forward.length+this.normal.length+this.backward.length},getFirst:function(){return this.forward.length>0?this.forward[0]:this.normal.length>0?this.normal[0]:this.backward.length>0?this.backward[this.backward.length-1]:null},add:function(t){t.backward?this.backward.unshift(t):t.forward?this.forward.push(t):this.normal.push(t)}},t}(),ce=function(){function t(t,e,n){this._type=n||"div",this.childExtent=0,this.childMeasure=0,this.size=t,this.childs=new le,this.css={},this.parent=e,this.charCount=0}return t.prototype={getCssBlock:function(){var t=this.css;return t["font-size"]=this.fontSize+"px",x.copy(t,this.size.getCss()),this.edge&&x.copy(t,this.edge.getCss()),this.parent&&x.copy(t,this.parent.flow.getCss()),this.color&&x.copy(t,this.color.getCss()),this.fontWeight&&x.copy(t,this.fontWeight.getCss()),this.letterSpacing&&!this.isTextVertical()&&(t["letter-spacing"]=this.letterSpacing+"px"),t.display=this.display||"block",t.overflow="hidden",t
},getCssInline:function(){var t=this.css;t["font-size"]=this.fontSize+"px",this.color&&x.copy(t,this.color.getCss()),this.fontWeight&&x.copy(t,this.fontWeight.getCss()),this.parent&&this.parent.isBlock()&&x.copy(t,this.flow.getCss());var e=this.getStartOffset();if(e>0){this.edge=new te,this.edge.setStart(this.flow,e);var n=this.getContentMeasure();this.size.setMeasure(this.flow,n-e)}return x.copy(t,this.size.getCss()),this.edge&&x.copy(t,this.edge.getCss()),this.isTextVertical()?(r.isIphoneFamily&&(t["letter-spacing"]="-0.001em"),void 0!==this.markup&&this.isRubyLine()||(t["margin-left"]=t["margin-right"]="auto",t["text-align"]="center")):1>=this.lineRate&&(t["line-height"]="1em"),t},getCssVertInlineBox:function(){var t=this.getCssBlock();return t["float"]="none",t["margin-left"]=t["margin-right"]="auto",t},getCharCount:function(){return this.charCount},getClasses:function(){return this.isTextLine()?this._getClassesInline():this._getClassesBlock()},_getClassesBlock:function(){var t=["nehan-box"];return"box"!=this._type&&t.push(d.addNehanPrefix(this._type)),t.concat(this.extraClasses||[])},_getClassesInline:function(){var t=["nehan-text-line"];return t.push("nehan-text-line-"+(this.isTextVertical()?"vert":"hori")),this.markup&&t.push("nehan-"+this.markup.getName()),t.concat(this.extraClasses||[])},getCssClasses:function(){return this.getClasses().join(" ")},getFirstChild:function(){return this.childs.getFirst()},getChilds:function(){return this.childs.get()},getChildExtent:function(){return this.childExtent},getChildMeasure:function(){return this.childMeasure},getFlowName:function(){return this.flow.getName()},getFlipFlow:function(){return this.flow.getFlipFlow()},getTextMeasure:function(){return this.childMeasure},getTextRestMeasure:function(){return this.getContentMeasure()-this.childMeasure},getRestContentExtent:function(){return this.getContentExtent()-this.childExtent},getContentMeasure:function(t){return this.size.getMeasure(t||this.flow)},getContentExtent:function(t){return this.size.getExtent(t||this.flow)},getMaxChildMeasure:function(t){var e=t||this.flow,n=0;return o.iter(this.getChilds(),function(t){var i=t.getTextMeasure?t.getTextMeasure():t.getContentMeasure(e);i>n&&(n=i)}),n},getContentWidth:function(){return this.size.width},getContentHeight:function(){return this.size.height},getBoxMeasure:function(t){var e=t||this.flow,n=this.getContentMeasure(e);return this.edge&&(n+=this.edge.getMeasureSize(e)),n},getBoxExtent:function(t){var e=t||this.flow,n=this.getContentExtent(e);return this.edge&&(n+=this.edge.getExtentSize(e)),n},getBoxWidth:function(){var t=this.size.width;return this.edge&&(t+=this.edge.getWidth()),t},getBoxHeight:function(){var t=this.size.height;return this.edge&&(t+=this.edge.getHeight()),t},getBoxSize:function(){return new se(this.getBoxWidth(),this.getBoxHeight())},getBorder:function(){return this.edge?this.edge.border:null},getStartOffset:function(){var t=this.textIndent||0;switch(this.textAlign){case"start":return t;case"end":return t+this.getTextRestMeasure();case"center":return t+Math.floor(this.getTextRestMeasure()/2);default:return t}},getRestSize:function(){var t=this.getContentMeasure(),e=this.getRestContentExtent();return this.flow.getBoxSize(t,e)},getFloatedWrapFlow:function(){return this.flow.getFloatedWrapFlow()},getParentFlow:function(){return this.parent?this.parent.flow:null},getParallelFlow:function(){return this.flow.getParallelFlow()},getParallelFlipFlow:function(){return this.flow.getParallelFlipFlow()},getPropStart:function(){return this.flow.getPropStart()},getPropAfter:function(){return this.flow.getPropAfter()},getInflow:function(){return this.flow.inflow},getBlockflow:function(){return this.flow.blockflow},getBoxFlowBoxSize:function(t,e){return this.flow.getBoxSize(t,e)},getEdgeWidth:function(){return this.edge?this.edge.getWidth():0},getEdgeHeight:function(){return this.edge?this.edge.getHeight():0},getMarkupName:function(){return this.markup?this.markup.getName():""},addClass:function(t){var e=this.extraClasses||[];e.push(t),this.extraClasses=e},addChildBlock:function(t){this.childs.add(t),this.childExtent+=t.getBoxExtent(this.flow),this.charCount+=t.getCharCount()},addChildInline:function(t,e){this.childs.add(t),this.childMeasure+=e},addExtent:function(t){this.size.addExtent(this.flow,t)},addMeasure:function(t){this.size.addMeasure(this.flow,t)},setInlineElements:function(t,e){this.childs.setNormal(t),this.childMeasure=e},setCss:function(t,e){this.css[t]=e},setType:function(t){this._type=t},setId:function(t){this.id=t},setParent:function(t,e){var n=e!==void 0?e:!0;this.parent=t,n&&this.setFlow(t.flow)},setFlow:function(t){t.isValid()&&(this.flow=t)},setContentExtent:function(t,e){this.size.setExtent(t,e)},setContentMeasure:function(t,e){this.size.setMeasure(t,e)},setEdge:function(t){var e=this.sizing?this.sizing:q.getByName("margin-box");e.isMarginBox()?this._setEdgeByMarginBox(t):e.isBorderBox()?this._setEdgeByBorderBox(t):e.isContentBox()&&(this.edge=t)},_setEdgeByMarginBox:function(t){this.size.subEdge(t),this.size.isValid()&&(this.edge=t)},_setEdgeByBorderBox:function(t){var e=new ne;e.border=t.border,e.padding=t.padding,this.size.subEdge(e),this.size.isValid()&&(this.edge=t)},setMaxFontSize:function(e){this.maxFontSize=e,o.iter(this.getChilds(),function(n){n instanceof t&&"text-line"===n._type&&n.setMaxFontSize(e)})},setMaxExtent:function(e){this.maxExtent=e,o.iter(this.getChilds(),function(n){n instanceof t&&"text-line"===n._type&&n.setMaxExtent(e)})},subMeasure:function(t){this.size.subMeasure(this.flow,t)},splitMeasure:function(t){for(var e=this.getContentMeasure(),n=Math.floor(e/t),i=[],r=0;t>r;r++)i.push(n);return i},isEmptyChild:function(){return 0===this.childs.getLength()},isFirstChildOf:function(t){if("text-line"===this.type)return!1;var e=this.getMarkupName();return"li-marker"===e||"li-body"===e?!1:t&&t.isEmptyChild()},isTextBold:function(){return this.fontWeight&&this.fontWeight.isBold()},isBlock:function(){return!this.isTextLine()},isTextLine:function(){return"text-line"===this._type},isTextLineRoot:function(){return this.parent&&this.parent.isBlock()},isInlineOfInline:function(){return this.isTextLine()&&this.markup&&this.markup.isInline()},isRubyLine:function(){return this.isTextLine()&&"ruby"===this.getMarkupName()},isRtLine:function(){return this.isTextLine()&&"rt"===this.getMarkupName()},isLinkLine:function(){return this.isTextLine()&&"a"===this.getMarkupName()},isFirstLetter:function(){return"first-letter"===this.getMarkupName()},isJustifyTarget:function(){var t=this.getMarkupName();return"first-letter"!==t&&"rt"!==t&&"li-marker"!==t},isTextVertical:function(){return this.flow.isTextVertical()},isTextHorizontal:function(){return this.flow.isTextHorizontal()},isValidSize:function(){return this.size.isValid()},canInclude:function(t){return this.size.canInclude(t)},clearEdge:function(){this.edge&&this.edge.clear()},clearBorderBefore:function(){this.edge&&this.edge.clearBorderBefore(this.flow)},clearBorderAfter:function(){this.edge&&this.edge.clearBorderAfter(this.flow)},shortenBox:function(t){var e=t||this.flow;return this.shortenMeasure(e),this.shortenExtent(e),this},shortenMeasure:function(t){return t=t||this.flow,this.size.setMeasure(t,this.childMeasure),this},shortenExtent:function(t){return t=t||this.flow,this.setContentExtent(t,this.childExtent),this}},t}(),fe={set:function(t,e,n){this._setFontSize(t,e,n),this._setFontColor(t,e,n),this._setFontFamily(t,e,n),this._setFontStyle(t,e,n),this._setFontWeight(t,e,n),this._setSizing(t,e,n),this._setEdge(t,e,n),this._setLineRate(t,e,n),this._setTextAlign(t,e,n),this._setTextIndent(t,e,n),this._setTextEmphasis(t,e,n),this._setFlowName(t,e,n),this._setFloat(t,e,n),this._setLetterSpacing(t,e,n),this._setBackground(t,e,n),this._setBackgroundColor(t,e,n),this._setBackgroundImage(t,e,n),this._setBackgroundPosition(t,e,n),this._setBackgroundRepeat(t,e,n),this._setClasses(t,e,n)},_setClasses:function(t,e){o.iter(t.classes,function(t){e.addClass(t)})},_setFontSize:function(t,e,n){var r=n?n.fontSize:i.fontSize,s=t.getCssAttr("font-size","inherit");"inherit"!=s&&(e.fontSize=h.getUnitSize(s,r))},_setFontColor:function(t,e){var n=t.getCssAttr("color");n&&(e.color=new P(n))},_setFontFamily:function(t,e){var n=t.getCssAttr("font-family");n&&e.setCss("font-family",n)},_setFontStyle:function(t,e){var n=t.getCssAttr("font-style");n&&e.setCss("font-style",n)},_setFontWeight:function(t,e){var n=t.getCssAttr("font-weight");n&&(e.fontWeight=new U(n))},_setSizing:function(t,e){var n=t.getCssAttr("box-sizing");n&&(e.sizing=q.getByName(n))},_setEdge:function(t,e){var n=t.getBoxEdge(e.flow,e.fontSize,e.getContentMeasure());n&&e.setEdge(n)},_setLineRate:function(t,e){var n=t.getCssAttr("line-rate","inherit");"inherit"!==n&&(e.lineRate=n)},_setTextAlign:function(t,e){var n=t.getCssAttr("text-align");n&&(e.textAlign=n)},_setTextIndent:function(t,e){var n=t.getCssAttr("text-indent","inherit");"inherit"!==n&&(e.textIndent=UnixSize.getUnitSize(n,e.fontSize))},_setTextEmphasis:function(t,e){var n=t.getCssAttr("text-emphasis-style");if(n){var i=t.getCssAttr("text-emphasis-position","over"),r=t.getCssAttr("text-emphasis-color","black"),s=new ue;s.setStyle(n),s.setPos(i),s.setColor(r),e.textEmpha=s}},_setFlowName:function(t,e,n){var i=t.getCssAttr("flow","inherit");"flip"===i?e.setFlow(n.getFlipFlow()):"inherit"!==i&&e.setFlow(G.getByName(i))},_setFloat:function(t,e){var n=t.getCssAttr("float","none");"none"!=n&&(e.logicalFloat=n)},_setLetterSpacing:function(t,e){var n=t.getCssAttr("letter-spacing");n&&(e.letterSpacing=h.getUnitSize(n,e.fontSize))},_setBackground:function(t,e){var n=t.getCssAttr("background");n&&e.setCss("background",n)},_setBackgroundColor:function(t,e){var n=t.getCssAttr("background-color");n&&e.setCss("background-color",n)},_setBackgroundImage:function(t,e){var n=t.getCssAttr("background-image");n&&e.setCss("background-image",n)},_setBackgroundPosition:function(t,e){var n=t.getCssAttr("background-position");n&&e.setCss("background-position",n)},_setBackgroundRepeat:function(t,e){var n=t.getCssAttr("background-repeat");n&&e.setCss("background-repeat",background_pos)}},ge=function(){function t(t){this.pos=0,this.buff=t,this.bufferLength=this.buff.length,this.empty=""===this.buff}var e=/\d\d|!\?|!!|\?!|\?\?/,n=/^([\w!\.\?\/\_:#;"',]+)/,i=/^(<[^>]+>)/,r=/^(&[^;\s]+;)/,s=0;return t.prototype={isEmpty:function(){return this.empty},get:function(){var t=this._getToken();return t&&(t.spos=this.pos,t._gtid=s++),t},getBufferLength:function(){return this.bufferLength},getSeekPercent:function(t){return Math.floor(100*t/this.bufferLength)},_stepBuff:function(t){this.pos+=t,this.buff=this.buff.slice(t)},_getToken:function(){if(""===this.buff)return null;if(this.buff.match(i))return this._parseTag(RegExp.$1);if(this.buff.match(n)){var t=RegExp.$1;return 1===t.length?this._parseChar(t):2===t.length&&t.match(e)?this._parseTcy(t):this._parseWord(t)}return this.buff.match(r)?this._parseCharRef(RegExp.$1):this._parseChar(this._getChar())},_getRb:function(){var t=this.buffRb.substring(0,1);return this.buffRb=this.buffRb.slice(1),t},_getChar:function(){return this.buff.substring(0,1)},_getTagContentAux:function(t){var e="<"+t,n="</"+t,i=function(i,r){var s=arguments.callee,a=i.indexOf(e,r),o=i.indexOf(n,r);if(0>a||a>o)return o;var u=s(i,a+t.length+2);return s(i,u+t.length+3)},r=i(this.buff,0);return 0>r?this.buff:this.buff.substring(0,r)},_getTagContent:function(t){try{return this._getTagContentAux(t)}catch(e){return""}},_parseTag:function(t){var e=new _(t);return this._stepBuff(t.length),e.isTcyTag()?this._parseTcyTag(e):e.isChildContentTag()?this._parseChildContentTag(e):e},_parseTcyTag:function(t){var e=this._getTagContent(t.name);return this._stepBuff(e.length+t.name.length+3),new E(e)},_parseChildContentTag:function(t){var e=this._getTagContent(t.name);return t.setContentRaw(l.trimCRLF(e)),this._stepBuff(e.length+t.name.length+3),t},_parseWord:function(t){return this._stepBuff(t.length),new T(t)},_parseTcy:function(t){return this._stepBuff(t.length),new E(t)},_parseChar:function(t){return this._stepBuff(t.length),new w(t,!1)},_parseCharRef:function(t){return this._stepBuff(t.length),new w(t,!0)}},t}(),de=function(){function t(){this.tags=[],this.head=null}return t.prototype={isEmpty:function(){return 0>=this.tags.length},isTagNameEnable:function(t){return this.exists(function(e){return e.getName()==t})},getDepth:function(){return this.tags.length},getDepthByName:function(t){return o.count(this.tags,function(e){return e.getName()==t})},getHead:function(){return this.head},pop:function(){var t=this.tags.pop();return this.head=this._getCurHead(),t},push:function(t){this.head=t,this.tags.push(t)},exists:function(t){return o.exists(this.tags,t)},find:function(t){return o.find(this.tags,t)},revfind:function(t){return o.revfind(this.tags,t)},iter:function(t){o.iter(this.tags,t)},reviter:function(t){o.revIter(this.tags,t)},filter:function(t){return o.filter(this.tags,t)},getByName:function(t){for(var e=this.tags.length-1;e>=0;e--){var n=this.tags[e];if(n.name==t)return n}return null},popByName:function(t){for(var e=this.tags.length-1;e>=0;e--){var n=this.tags[e];if(n.name==t){var i=this.tags.splice(e,1)[0];return this.head=this._getCurHead(),i}}return null},_getCurHead:function(){return 0===this.tags.length?null:this.tags[this.tags.length-1]}},t}(),pe=function(){function t(t,e,n){this.rank=t,this.title=e,this._id=n||0}return t.prototype={getId:function(){return this._id}},t}(),me=function(){function t(t,e,n){this._type=t,this._header=null,this._auto=!1,this._next=null,this._child=null,this._parent=e||null,this._pageNo=n||0}return t.prototype={isRoot:function(){return null===this._parent},isAuto:function(){return this._auto},hasHeader:function(){return null!==this._header},hasHeaderId:function(){return this.getHeaderId()>0},hasChild:function(){return null!==this._child},hasNext:function(){return null!==this._next},getNext:function(){return this._next},getChild:function(){return this._child},getParent:function(){return this._parent},getHeader:function(){return this._header},getHeaderId:function(){return this._header?this._header.getId():null},setHeader:function(t){this._header=t},setAuto:function(){this._auto=!0},getRank:function(){return this._header?this._header.rank:0},getTitle:function(){return this._header?this._header.title:["untitled",this._type].join(" ")},getType:function(){return this._type},getPageNo:function(){return this._pageNo},updatePageNo:function(t){this._pageNo=t},addChild:function(t){null===this._child?this._child=t:this._child.addNext(t)},addNext:function(t){null===this._next?this._next=t:this._next.addNext(t)}},t}(),xe=function(){function t(){this.stack=[1]}return t.prototype={getTocStack:function(){return this.stack},getTocId:function(){return this.stack.join(".")},stepNext:function(){var t=this.stack.length;return t>0&&this.stack[t-1]++,this},startRoot:function(){return this.stack.push(1),this},endRoot:function(){return this.stack.pop(),this}},t}(),ke=function(){function t(t){this.rootName=t,this.logs=[]}return t.prototype={isEmpty:function(){return 0===this.logs.length},get:function(t){return this.logs[t]||null},getSectionRootName:function(){return this.rootName},addSectionLog:function(t){this.logs.push(t)},addHeaderLog:function(t){var e=this._findLog(t);return e>=0?(this.logs[e]=t,void 0):(this.logs.push(t),void 0)},_isSameLog:function(t,e){for(var n in t)if("pageNo"!=n&&"headerId"!=n&&t[n]!=e[n])return!1;return!0},_findLog:function(t){for(var e=this.logs.length-1;e>=0;e--)if(this._isSameLog(t,this.logs[e]))return e;return-1}},t}(),ve=function(){function t(){this._buffers={},this._stack=[],this._curSection="body"}return t.prototype={_addHeaderLog:function(t){var e=this.getOutlineBuffer(this._curSection);e.addHeaderLog(t)},_addSectionLog:function(t){var e=this.getOutlineBuffer(this._curSection);e.addSectionLog(t)},getOutlineBuffer:function(t){var e=this._buffers[t]||new ke(t);return this._buffers[t]=e,e},startSectionRoot:function(t){this._stack.push(t),this._curSection=t},endSectionRoot:function(){return this._curSection=this._stack.pop()||"body",this._curSection},logStartSection:function(t,e){this._addSectionLog({name:"start-section",type:t,pageNo:e})},logEndSection:function(t){this._addSectionLog({name:"end-section",type:t})},logSectionHeader:function(t,e,n,i,r){this._addHeaderLog({name:"set-header",type:t,rank:e,title:n,pageNo:i,headerId:r})}},t}(),be=function(){function t(t){this._ptr=0,this._logs=t,this._root=new me("section",null,0)}return t.prototype={getTree:function(){return this._parse(this._root,this),this._root},_getNext:function(){return this._logs.get(this._ptr++)},_rollback:function(){this._ptr=Math.max(0,this._ptr-1)},_parse:function(t,e){var n=e._getNext();if(null!==n)switch(n.name){case"start-section":var i=new me(n.type,t,n.pageNo);t&&t.addChild(i),arguments.callee(i,e);break;case"end-section":arguments.callee(t.getParent(),e);break;case"set-header":var r=new pe(n.rank,n.title,n.headerId);if(null===t){var s=new me("section",null,n.pageNo);s.setHeader(r),arguments.callee(s,e)}else if(t.hasHeader()){var a=n.rank,o=t.getRank();if(o>a)e._rollback(),arguments.callee(t.getParent(),e);else if(n.rank==o){var u=new me("section",t,n.pageNo);u.setHeader(r),t.addNext(u),arguments.callee(u,e)}else{var h=new me("section",t,n.pageNo);h.setHeader(r),t.addChild(h),arguments.callee(h,e)}}else t.setHeader(r),arguments.callee(t,e)}}},t}(),ye=function(){function t(t,e){this.tree=t,x.copy(this,e||{})}return t.prototype={outputNode:function(){var t=new xe;return this._parseTree(this,this.createRoot(),this.tree,t)},_createToc:function(t,e){return{title:t.getTitle(),pageNo:t.getPageNo(),tocId:e.getTocId(),headerId:t.getHeaderId()}},_parseTree:function(t,e,n,i){if(null===n)return e;var r=t._createToc(n,i),s=t.createChild(r),a=t.createLink(r);a&&(a.onclick=function(){return t.onClickLink(r)},s.appendChild(a));var o=t.createPageNoItem(r);o&&s.appendChild(o),e.appendChild(s);var u=n.getChild();if(u){i=i.startRoot();var h=t._createToc(u,i),l=t.createRoot(h);arguments.callee(t,l,u,i),s.appendChild(l),i=i.endRoot()}var c=n.getNext();return c&&arguments.callee(t,e,c,i.stepNext()),e},onClickLink:function(){return!1},createRoot:function(){var t=document.createElement("ol");return t.className="nehan-toc-root",t},createChild:function(){var t=document.createElement("li");return t.className="nehan-toc-item",t},createLink:function(t){var e=document.createElement("a"),n=t.title.replace(/<a[^>]+>/gi,"").replace(/<\/a>/gi,"");return e.href="#"+t.pageNo,e.innerHTML=n,e.className="nehan-toc-link",e.id=d.addNehanTocLinkPrefix(t.tocId),e},createPageNoItem:function(){return null}},t}(),Ce=function(){function t(){this.title="",this.metas=[],this.links=[],this.scripts=[],this.styles=[]}return t.prototype={setTitle:function(t){this.title=t},getTitle:function(){return this.title},addLink:function(t){this.links.push(t)},getLinks:function(){return this.links},addMeta:function(t){this.metas.push(t)},getMetas:function(){return this.metas},getMetaByName:function(t){return o.find(this.metas,function(e){return e.getTagAttr("name")===t})},getMetaContentByName:function(t){var e=this.getMetaByName(t);return e?e.getTagAttr("content"):null},addScript:function(t){this.scripts.push(t)},getScripts:function(){return this.scripts},addStyle:function(t){this.styles.push(t)},getStyles:function(){return this.styles}},t}(),_e=function(){function t(){this.tagStack=new de}return t.prototype={pushTag:function(t){this.tagStack.push(t)},popTag:function(){return this.tagStack.pop()},getHeadTag:function(){return this.tagStack.getHead()},getTagStack:function(){return this.tagStack},getTagDepth:function(){return this.tagStack.getDepth()},getTagDepthByName:function(t){return this.tagStack.getDepthByName(t)},findTag:function(t){return this.tagStack.find(t)},isEmpty:function(){return this.tagStack.isEmpty()},isTagEnable:function(t){return this.tagStack.exists(t)},isTagNameEnable:function(t){return this.tagStack.isTagNameEnable(t)},isHeaderEnable:function(){return this.tagStack.exists(function(t){return t.isHeaderTag()})}},t}(),Se=function(){function t(){this.tagStack=new de}return t.prototype={pushTag:function(t){this.tagStack.push(t)},popTag:function(){return this.tagStack.pop()},getHeadTag:function(){return this.tagStack.getHead()},getTagStack:function(){return this.tagStack},getTagDepth:function(){return this.tagStack.getDepth()},findTag:function(t){return this.tagStack.find(t)},isEmpty:function(){return this.tagStack.isEmpty()},isTagEnable:function(t){return this.tagStack.exists(t)},isTagNameEnable:function(t){return this.tagStack.isTagNameEnable(t)}},t}(),we=function(){function t(t){var e=t||{};this.charPos=e.charPos||0,this.pageNo=e.pageNo||0,this.header=e.header||new Ce,this.blockContext=e.blockContext||new _e,this.inlineContext=e.inlineContext||new Se,this.outlineContext=e.outlineContext||new ve,this.anchors=e.anchors||{}}var e=0;return t.prototype={getHeader:function(){return this.header},addScript:function(t){this.header.addScript(t)},addStyle:function(t){this.header.addStyle(t)},getPageNo:function(){return this.pageNo},getCharPos:function(){return this.charPos},stepPageNo:function(){this.pageNo++},addCharPos:function(t){this.charPos+=t},createInlineRoot:function(){return new t({charPos:this.charPos,pageNo:this.pageNo,header:this.header,anchors:this.anchors,outlineContext:this.outlineContext,blockContext:this.blockContext})},inheritTag:function(t){var e=this.getCurBlockTag();if(t.hasLayout()){e&&t.inherit(e);var n=t.getCssAttr("onload");n&&n(this,t)}},isEmptyMarkupContext:function(){return this.inlineContext.isEmpty()},setAnchor:function(t){this.anchors[t]=this.pageNo},getAnchors:function(){return this.anchors},getAnchorPageNo:function(t){return this.anchors[t]||-1},getCurInlineTag:function(){return this.inlineContext.getHeadTag()},getInlineTagStack:function(){return this.inlineContext.getTagStack()},getInlineTagDepth:function(){return this.inlineContext.getTagDepth()},pushInlineTag:function(t){this.inlineContext.pushTag(t)},popInlineTag:function(){return this.inlineContext.popTag()},findInlineTag:function(t){return this.inlineContext.findTag(t)},isInlineTagEnable:function(t){return this.inlineContext.isTagEnable(t)},isHeaderEnable:function(){return this.blockContext.isHeaderEnable()},pushBlockTag:function(t){this.blockContext.pushTag(t)},popBlockTag:function(){return this.blockContext.popTag()},getBlockTagStack:function(){return this.blockContext.getTagStack()},getCurBlockTag:function(){return this.blockContext.getHeadTag()},getBlockDepth:function(){return this.blockContext.getTagDepth()},getBlockDepthByName:function(t){return this.blockContext.getTagDepthByName(t)},getOutlineTitle:function(){return this.blockContext.getOutlineTitle()},findBlockTag:function(t){return this.blockContext.findTag(t)},isBlockTagEnable:function(t){return this.blockContext.isTagEnable(t)},getOutlineBuffer:function(t){return this.outlineContext.getOutlineBuffer(t)},startSectionRoot:function(t){var e=t.getName();this.outlineContext.startSectionRoot(e)},endSectionRoot:function(t){var e=t.getName();return this.outlineContext.endSectionRoot(e)},logStartSection:function(t){var e=t.getName();this.outlineContext.logStartSection(e,this.pageNo)},logEndSection:function(t){var e=t.getName();this.outlineContext.logEndSection(e)},logSectionHeader:function(t){var n=t.getName(),i=t.getHeaderRank(),r=t.getContentRaw(),s=this.pageNo,a=e++;return this.outlineContext.logSectionHeader(n,i,r,s,a),a}},t}(),Te=function(){function t(t,e){this.rowCount=t,this.maxCol=e,this.map=this._create(t,e)}return t.prototype={_create:function(t,e){for(var n=[],i=function(t){for(var e=[],n=0;t>n;n++)e.push({start:0,end:0,before:0,after:0});return e},r=0;t>r;r++)n.push(i(e));return n},get:function(t,e){return this.map[t][e]},getAsStyle:function(t,e){var n=this.get(t,e),i={};for(var r in n)i[r]=n[r]+"px";return i},set:function(t,e,n){for(var i in n)this.setBorderProp(t,e,i,n)},collapse:function(){this._collapseCol(),this._collapseRow()},_collapseCol:function(){for(var t=0;this.rowCount>t;t++)for(var e=0;this.maxCol-1>e;e++){var n=this.get(t,e),i=this.get(t,e+1);n.end&&i.start&&(n.end>i.start?i.start=0:n.end=0)}},_collapseRow:function(){for(var t=0;this.rowCount-1>t;t++)for(var e=0;this.maxCol>e;e++){var n=this.get(t,e),i=this.get(t+1,e);n.after&&i.before&&(n.after>i.before?i.before=0:n.after=0)}},setBorderProp:function(t,e,n,i){var r=this.get(t,e);i[n]>r[n]&&(r[n]=i[n])},setRange:function(t,e,n,i,r){for(var s=t;n>s;s++)for(var a=e;i>a;a++)s==t&&this.setBorderProp(s,a,"before",r),s==n-1&&this.setBorderProp(s,a,"after",r),a==e&&this.setBorderProp(s,a,"start",r),a==i-1&&this.setBorderProp(s,a,"end",r)}},t}(),Ee=function(){var t=function(t,e){var n=e.getCssAttr("border-width");if(null===n)return null;var i=h.getEdgeSize(n,t.fontSize,t.getContentMeasure());return"number"==typeof i?{before:i,after:i,start:i,end:i}:i},e=function(e,n,i){var r=t(n,i);if(null!==r)switch(i.name){case"table":e.setRange(0,0,e.rowCount,e.maxCol,r);break;case"thead":case"tbody":case"tfoot":var s=i.row,a=s+i.tableChilds.length;e.setRange(s,0,a,e.maxCol);break;case"tr":e.setRange(i.row,0,i.row+1,e.maxCol);break;case"td":case"th":e.set(i.row,i.col,r)}},n=function(t,n,i){var r=arguments.callee;e(t,n,i),o.iter(i.tableChilds||[],function(e){r(t,n,e)})},i=function(t,e){var n=arguments.callee;switch(e.name){case"table":case"thead":case"tbody":case"tfoot":case"tr":e.setCssAttr("border-width","0px");break;case"td":case"th":var i=t.getAsStyle(e.row,e.col);e.setCssAttr("border-width",i)}o.iter(e.tableChilds||[],function(e){n(t,e)})};return{set:function(t,e){var r=new Te(t.rowCount,t.maxCol);n(r,e,t),r.collapse(),i(r,t)}}}(),Be=a.extend({init:function(t){this.lexer=new ge(t),this.tokens=[],this.pos=0,this.backupPos=0,this.eof=!1,this._doBuffer()},hasNext:function(){return!this.isEnd()},isEmpty:function(){return this.lexer.isEmpty()},isEmptyTokens:function(){return 0===this.tokens.length},isHead:function(){return 0===this.pos},isEnd:function(){return this.eof&&this.pos>=this.tokens.length},backup:function(){this.backupPos=this.pos},rollback:function(){this.pos=this.backupPos},next:function(t){var e=t||1;this.pos=this.pos+e},prev:function(){this.pos=Math.max(0,this.pos-1)},setPos:function(t){this.pos=t},skipIf:function(t){var e=this.peek();e&&t(e)&&this.next()},skipUntil:function(t){for(;this.hasNext();){var e=this.get();if(null===e)break;if(!t(e)){this.prev();break}}},rewind:function(){this.pos=0},peek:function(t){var e=t||0,n=Math.max(0,this.pos+e);if(n>=this.tokens.length){if(this.eof)return null;this._doBuffer()}var i=this.tokens[n];return i.pos=n,i},get:function(){var t=this.peek();return this.pos++,t},getPos:function(){return this.pos},getAll:function(){for(;!this.eof;)this._doBuffer();return this.tokens},getAllIf:function(t){return o.filter(this.getAll(),function(e){return t(e)})},getTokenCount:function(){return this.tokens.length},getSeekPos:function(){var t=this.tokens[this.pos];return t?t.spos:0},getSeekPercent:function(){var t=this.getSeekPos();return this.lexer.getSeekPercent(t)},iterWhile:function(t,e){for(var n=1==arguments.length?this.pos:t;n>=0;){if(n>=this.tokens.length){if(this.eof)break;this._doBuffer(),this.iterWhile(n,e);break}if(!e(n,this.tokens[n]))break;n++}},revIterWhile:function(t,e){for(var n=1==arguments.length?this.pos:t;n>=0&&e(n,this.tokens[n]);)n--},findTextPrev:function(t){var e=e!==void 0?t:this.pos,n=null;return this.revIterWhile(e-1,function(t,e){return S.isText(e)?(n=e,!1):!0}),n},findTextNext:function(t){var e=t!==void 0?t:this.pos,n=null;return this.iterWhile(e+1,function(t,e){return S.isText(e)?(n=e,!1):!0}),n},_doBuffer:function(){for(var t=this,e=n.lexingBufferLen,i=function(e){t.tokens.push(e)},r=0;e>r;r++){var s=this.lexer.get();if(null===s){this.eof=!0;break}i(s)}}}),ze=Be.extend({init:function(t,e){var n=0;this._super(t),this.tokens=this.getAllIf(function(t){return S.isText(t)?!1:e(t)?(t.order=n++,!0):void 0})}}),Pe=Be.extend({init:function(t){this._super(""),this.tokens=t},isEmpty:function(){return 0===this.tokens.length}});Be.extend({init:function(t){this._super(t),this.tokens=this.getAllIf(function(t){return S.isText(t)?!0:t.isInline()||t.isInlineBlock()})}});var Ie=ze.extend({init:function(t){this._super(t,function(t){var e=t.getName();return"!doctype"===e||"html"===e}),this.isEmptyTokens()&&(this.tokens=[new _("html",t)])}}),Ne=ze.extend({init:function(t){this._super(t,function(t){var e=t.getName();return"head"===e||"body"===e}),this.isEmptyTokens()&&(this.tokens=[new _("body",t)])}}),Ae=ze.extend({init:function(t){this._super(t,function(t){var e=t.getName();return"title"===e||"meta"===e||"link"===e||"style"===e||"script"===e})}}),Me=ze.extend({init:function(t){this._super(t.getContent(),function(t){var e=t.getName();return"thead"===e||"tbody"===e||"tfoot"===e||"tr"===e}),this.markup=t,this.markup.tableChilds=this.tokens=this._parseTokens(this.tokens)},getPartition:function(t){var e=this,n=new re,i=t.getContentMeasure();return o.iter(this.tokens,function(r){var s=r.tableChilds;o.iter(s,function(r){var s=r.tableChilds,a=s.length;if(null===n.getPartition(a)){var o=e._parsePartition(s,t);n.add(new ie(o,i))}})}),n},_setChildTokens:function(t,e){t.tableChilds=e;var n=e.length;return n>0&&(t.firstChild=e[0],t.lastChild=e[n-1]),t},_parseTokens:function(t){var e=[],n=[],i=[],r=this,s=null,a=null,u=null,h={row:0,col:0,maxCol:0};o.iter(t,function(t){if(S.isTag(t))switch(t.name){case"tr":t.row=h.row,r._setChildTokens(t,r._parseCols(h,t.getContent())),h.row++,i.push(t);break;case"thead":s=t,e=e.concat(r._parseRows(h,t.getContent()));break;case"tbody":a=t,i=i.concat(r._parseRows(h,t.getContent()));break;case"tfoot":u=t,n=n.concat(r._parseRows(h,t.getContent()))}});var l=[],c=0;return e.length>0&&(null===s&&(s=new _("<thead>")),this._setChildTokens(s,e),s.row=c,c+=s.tableChilds.length,l.push(s)),i.length>0&&(null===a&&(a=new _("<tbody>")),this._setChildTokens(a,i),a.row=c,c+=a.tableChilds.length,l.push(a)),n.length>0&&(null===u&&(u=new _("<tfoot>")),this._setChildTokens(u,n),u.row=c,l.push(u)),this._setChildTokens(this.markup,l),this.markup.maxCol=h.maxCol,this.markup.rowCount=h.row,l},_parsePartition:function(t,e){return o.map(t,function(t){var n=t.getTagAttr("measure")||t.getTagAttr("width")||0;return n?h.getBoxSize(n,e.fontSize,e.getContentMeasure()):0})},_parseRows:function(t,e){var n=this,i=new ze(e,function(t){return"tr"===t.getName()}).getAll();return o.map(i,function(e){return e.row=t.row,e=n._setChildTokens(e,n._parseCols(t,e.getContent())),t.row++,e})},_parseCols:function(t,e){var n=new ze(e,function(t){var e=t.getName();return"td"===e||"th"===e}).getAll();return o.iteri(n,function(e,n){n.row=t.row,n.col=e}),n.length>t.maxCol&&(t.maxCol=n.length),n}}),Re=ze.extend({init:function(t){this._super(t,function(t){return"li"===t.getName()})}}),Le=ze.extend({init:function(t){this._super(t,function(t){var e=t.getName();return"dt"===e||"dd"===e})}}),Fe=Be.extend({init:function(t){this._super(t),this.getAll(),this.tokens=this._parse(),this.rewind()},_parse:function(){for(var t=[];this.hasNext();)t.push(this._parseRuby());return t},_parseRuby:function(){for(var t=[],e=null;;){var n=this.get();if(null===n)break;if(S.isTag(n)&&"rt"===n.getName()){e=n;break}S.isText(n)&&t.push(n)}return new B(t,e)}}),He=function(){function t(t){if(this.context=new we,this.stream=new Ie(t),this.generator=this._createGenerator(),null===this.generator)throw"DocumentGenerator::invalid document"}return t.prototype={yield:function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},getTitle:function(){return this.context.getTitle()},getMeta:function(t){return this.context.getMeta(t)},getOutline:function(t){return this.generator.getOutline(t)},getOutlineHtml:function(t){return this.generator.getOutlineHtml(t)},_parseDocType:function(){},_createGenerator:function(){for(var t=null;;){var e=this.stream.get();
if(null===e)break;switch(e.getName()){case"!doctype":this._parseDocType(e);break;case"html":t=new Ve(e,this.context)}}return t}},t}(),Ve=function(){function t(t,e){if(this.markup=t,this.context=e||new we,this.stream=this._createStream(),this.generator=this._getGenerator(),null===this.generator)throw"HtmlGenerator::invalid html"}return t.prototype={yield:function(){return this.generator.yield()},hasNext:function(){return this.generator.hasNext()},getOutline:function(t){return this.generator.getOutline(t)},getOutlineHtml:function(t){return this.generator.getOutlineHtml(t)},_createStream:function(){return new Ne(this.markup.getContentRaw())},_getGenerator:function(){for(var t=null;;){var e=this.stream.get();if(null===e)break;switch(e.getName()){case"head":this._parseHead(e.getContentRaw());break;case"body":t=new sn(e,this.context)}}return t},_parseHead:function(t){for(var e=new Ae(t),n=this.context.getHeader();;){var i=e.get();if(null===i)break;switch(i.getName()){case"title":this._parseTitle(n,i);break;case"meta":this._parseMeta(n,i);break;case"link":this._parseLink(n,i);break;case"style":this._parseStyle(n,i);break;case"script":this._parseScript(n,i)}}},_parseTitle:function(t,e){t.setTitle(e.getContentRaw())},_parseMeta:function(t,e){t.addMeta(e)},_parseLink:function(t,e){t.addLink(e)},_parseStyle:function(t,e){t.addStyle(e)},_parseScript:function(t,e){t.addScript(e)}},t}(),We=a.extend({init:function(t,e){this.markup=t,this.context=e},hasNext:function(){return!1},backup:function(){},rollback:function(){},_onReadyBox:function(){},_onCreateBox:function(){},_getMarkupStaticSize:function(t){var e=t?t.fontSize:i.fontSize,n=t?t.getContentMeasure(t.flow):i.getStdMeasure();return this.markup.getStaticSize(e,n)},_yieldStaticElement:function(t,e){switch(e.getName()){case"img":return new De(e,this.context).yield(t);case"ibox":return new Ge(e,this.context).yield(t);case"div":return e.hasFlow()?new on(e,this.context.createInlineRoot()).yield(t):new Ge(e,this.context).yield(t);default:return new on(e,this.context.createInlineRoot()).yield(t)}},_getBoxType:function(){return this.markup.getName()},_setBoxFirstChild:function(t,e){t.isFirstChildOf(e)&&this.markup.setFirstChild()},_setBoxClasses:function(t){o.iter(this.markup.classes,function(e){t.addClass(e)})},_setBoxStyle:function(t,e){fe.set(this.markup,t,e)},_createBox:function(t,e){var n=this._getBoxType(),r=i.createBox(t,e,n);return r.markup=this.markup,this._onReadyBox(r,e),this._setBoxFirstChild(r,e),this._setBoxClasses(r,e),this._setBoxStyle(r,e),this._onCreateBox(r,e),r}}),Oe=We.extend({_getBoxSize:function(t){return this._getMarkupStaticSize(t)},_createBox:function(t,e){var n=this._super(t,e);return n.sizing=q.getByName("content-box"),n},yield:function(t){var e=this._getBoxSize(t),r=this._createBox(e,t);this.markup.isPush()&&(r.backward=!0),this.markup.isPull()&&(r.forward=!0);var s=t.getRestSize();if(s.width-=r.getEdgeWidth(),s.height-=r.getEdgeHeight(),!s.isValid())return k.RETRY;if(s.canInclude(r.size))return r;var a=i.getStdPageSize(),o=r.size.resizeWithin(t.flow,s);return!a.canInclude(r.size)||o.percentFrom(r.size)>=n.minBlockScaleDownRate?(r.size=o,r):k.RETRY}}),Ge=Oe.extend({_getBoxType:function(){return"ibox"},_onCreateBox:function(t){t.content=this.markup.getContentRaw(),t.css.overflow="hidden"}}),De=Oe.extend({_onCreateBox:function(t){t.src=this.markup.getTagAttr("src")}}),Ke=We.extend({_getBoxSize:function(t){var e=t?t.getContentMeasure():i.getStdMeasure();return t.flow.getBoxSize(e,1)},yield:function(t){var e=this._getBoxSize(t),n=this._createBox(e,t);return n}}),je=function(){function t(t,e,n){this.line=t,this.stream=e,this.context=n,this.markup=this.context.getCurInlineTag()||null,this.lineStartPos=this.stream.getPos(),this.textIndent=e.isHead()?t.textIndent||0:0,this.maxFontSize=0,this.maxExtent=0,this.maxMeasure=t.getContentMeasure()-this.textIndent,this.curMeasure=0,this.lineMeasure=t.getContentMeasure()-this.textIndent,this.startTokens=[],this.lineTokens=[],this.endTokens=[],this.lineBreak=!1,this.charCount=0,this.lastToken=null,this.prevText=null,this.lastText=null}return t.prototype={getElementExtent:function(t){return S.isText(t)?(S.isChar(t)||S.isTcy(t))&&this.line.textEmpha?this.line.textEmpha.getExtent(this.line.fontSize):this.line.fontSize:t instanceof B?t.getExtent(this.line.fontSize):t.getBoxExtent(this.getLineFlow())},getElementFontSize:function(t){return t instanceof ce?t.fontSize:this.line.fontSize},getElementAdvance:function(t){return S.isText(t)?t.getAdvance(this.getLineFlow(),this.getLetterSpacing()):t instanceof B?t.getAdvance(this.getLineFlow()):t.getBoxMeasure(this.getLineFlow())},getFontSize:function(){return this.line.fontSize},getMaxFontSize:function(){return this.maxFontSize},getMaxExtent:function(){return this.maxExtent},getLineFlow:function(){return this.line.flow},getLetterSpacing:function(){return this.line.letterSpacing||0},_isJustifyElement:function(t){return t instanceof w?!0:t instanceof B&&this.curMeasure>0?!0:!1},canContain:function(t,e){return this.line.isJustifyTarget()?this.curMeasure+e+this.line.fontSize<=this.maxMeasure:this.curMeasure+e<=this.maxMeasure},isPreLine:function(){return"pre"===this.line._type},isTextBold:function(){return this.line.isTextBold()},isEmptyText:function(){return 0===this.lineTokens.length},isInlineTagEmpty:function(){return 0>=this.context.getInlineTagDepth()},isOverWithoutLineBreak:function(){return!this.lineBreak&&this.lineTokens.length>0},isLineStart:function(){return this.stream.pos==this.lineStartPos},pushBackToken:function(){this.stream.prev()},findFirstText:function(){return this.stream.findTextNext(this.lineStartPos)},skipToken:function(){this.stream.next()},getNextToken:function(){var t=this.stream.get();if(t)if(S.isChar(t)&&t.isHalfSpaceChar()&&this.isLineStart()){var e=this.findFirstText();e&&S.isWord(e)&&(t=this.stream.get())}else S.isTag(t)&&this.context.inheritTag(t);return this.lastToken=t,t&&S.isText(t)&&this._setKerning(t),t},getTextTokenLength:function(){return this.lineTokens.length},getRestMeasure:function(){return this.line.getContentMeasure()-this.curMeasure},getMaxMeasure:function(){return this.maxMeasure},addStyle:function(t){this.context.addStyle(t)},addElement:function(t){var e=this.getElementAdvance(t);if(!this.canContain(t,e)){if(e>0&&0===this.curMeasure)throw"LayoutError";throw"OverflowInline"}var n=this.getElementFontSize(t);n>this.maxFontSize&&this._setMaxFontSize(n);var i=this.getElementExtent(t);if(i>this.maxExtent&&this._setMaxExtent(i),S.isTag(t)?this._addTag(t):t instanceof B?this._addRuby(t):t instanceof ce?(t.logicalFloat&&this._setLogicalFloat(t,t.logicalFloat),"text-line"===t._type?this._addTextLine(t):this._addInlineBlock(t)):this._addText(t),e>0&&this._addAdvance(e),this.curMeasure===this.maxMeasure)throw"FinishInline"},_setLogicalFloat:function(t,e){switch(e){case"start":t.forward=!0;break;case"end":t.backward=!0}},setAnchor:function(t){this.context.setAnchor(t)},setLineBreak:function(){this.lastText=null,this.lineBreak=!0},createInlineRoot:function(){return this.context.createInlineRoot()},createLine:function(){return 0===this.curMeasure?this._createEmptyLine():(this.isOverWithoutLineBreak()&&this.justify(this.lastToken),this._createTextLine())},justify:function(t){var e=t,n=this.stream.findTextPrev(),i=this.stream.getPos();e&&S.isChar(e)&&e.isHeadNg()&&(this.lineTokens=this._justifyHead(e),this.stream.getPos()!=i&&(n=this.stream.findTextPrev(),this.stream.skipIf(function(t){return t&&S.isTag(t)&&"br"===t.getName()}))),n&&S.isChar(n)&&n.isTailNg()&&(this.lineTokens=this._justifyTail(n))},_addAdvance:function(t){this.curMeasure+=t},_setMaxExtent:function(t){this.maxExtent=t},_setMaxFontSize:function(t){this.maxFontSize=t},_setKerning:function(t){if(this.prevText=this.lastText,this.lastText=t,S.isChar(t))if(t.isKakkoStart())this._setKerningStart(t,this.prevText);else if(t.isKakkoEnd()||t.isKutenTouten()){var e=this.stream.findTextNext(t.pos);this._setKerningEnd(t,e)}},_setKerningStart:function(t,e){var n=this._getTextSpaceStart(t,e);n>0&&(t.spaceRateStart=n)},_setKerningEnd:function(t,e){var n=this._getTextSpaceEnd(t,e);n>0&&(t.spaceRateEnd=n)},_getTextSpaceStart:function(t,e){return null===e?.5:S.isChar(e)&&e.isKakkoStart()?0:.5},_getTextSpaceEnd:function(t,e){return null===e?.5:S.isChar(e)&&(e.isKakkoEnd()||e.isKutenTouten())?0:.5},_pushElement:function(t){t.forward?this.startTokens.push(t):t.backward?this.endTokens.push(t):this.lineTokens.push(t)},_getLineTokens:function(){return this.startTokens.concat(this.lineTokens).concat(this.endTokens)},_addRuby:function(t){this._pushElement(t)},_addTag:function(t){this._pushElement(t)},_addInlineBlock:function(t){this._pushElement(t)},_addTextLine:function(t){this._pushElement(t),this.charCount+=t.getCharCount()},_addText:function(t){this._pushElement(t),this.charCount+=t.getCharCount()},_justifyHead:function(t){var e=0;if(this.stream.iterWhile(t.pos,function(t,n){return S.isChar(n)&&n.isHeadNg()?(e++,!0):!1}),0>=e)return this.lineTokens;if(1===e)return this._pushElement(t),this.stream.setPos(t.pos+1),this.lineTokens;var n=-1;if(this.stream.revIterWhile(t.pos,function(t,e){return this.lineStartPos>=t?!1:S.isChar(e)&&!e.isHeadNg()?(n=t,!1):!0}),0>n)return this.lineTokens;for(var i=t.pos;i>n;)this.lineTokens.pop(),i--;return this.stream.setPos(n),this.lineTokens},_justifyTail:function(t){var e=0;if(this.stream.revIterWhile(t.pos,function(t,n){return S.isChar(n)&&n.isTailNg()?(e++,!0):!1}),0>=e)return this.lineTokens;if(1===e)return this.lineTokens.pop(),this.stream.setPos(t.pos),this.lineTokens;var n=-1;if(this.stream.revIterWhile(t.pos,function(t,e){return this.lineStartPos>=t?!1:S.isChar(e)&&!e.isTailNg()?(n=t,!1):!0}),0>n)return this.lineTokens;for(var i=t.pos;i>n;)this.lineTokens.pop(),i--;return this.stream.setPos(n+1),this.lineTokens},_createEmptyLine:function(){return this.line.size=this.line.flow.getBoxSize(this.lineMeasure,this.maxFontSize),this.line.setInlineElements([],this.lineMeasure),this.line},_createTextLine:function(){var t=Math.floor(this.maxFontSize*(this.line.lineRate-1)),e=this.maxFontSize+t;return this.maxExtent=Math.max(this.maxExtent,e),this.line.size=this.line.flow.getBoxSize(this.lineMeasure,this.maxExtent),this.line.charCount=this.charCount,this.line.setInlineElements(this._getLineTokens(),this.curMeasure),this.line.textIndent=this.textIndent,this.line}},t}(),qe=We.extend({init:function(t,e,n){this.markup=t,this.stream=e,this.context=n,this._terminate=!1,this.lineNo=0},hasNext:function(){return this._terminate?!1:this.generator&&this.generator.hasNext()?!0:this.stream.hasNext()},backup:function(){this.stream.backup()},rollback:function(){this.stream.rollback(),this.generator=null},_getLineSize:function(t){var e=t.getContentMeasure(),n=t.getContentExtent();return t.flow.getBoxSize(e,n)},_setFirstLineStyle:function(t,e){var n=this.markup?this.markup.getPseudoElementCssAttr("first-line"):{};if(!u.isEmpty(n)){var i=new _("<first-line>");i.setCssAttrs(n),fe.set(i,t,e)}},_createLine:function(t){var e=this._getLineSize(t),n=i.createTextLine(e,t);return 0===this.lineNo&&this._setFirstLineStyle(n,t),n.markup=this.markup,n.lineNo=this.lineNo,n},yield:function(t){var e=this._createLine(t);return this._yield(e)},_yield:function(t){var e=new je(t,this.stream,this.context);for(this.backup();;){var n=this._yieldElement(e);if(n==k.BUFFER_END){e.setLineBreak();break}if(n==k.SKIP)return k.IGNORE;if(n==k.LINE_BREAK){e.setLineBreak();break}if(n==k.RETRY){e.setLineBreak();break}if(n!=k.IGNORE){if(n==k.BREAK){e.setLineBreak();break}try{e.addElement(n)}catch(i){"OverflowInline"===i&&(this.generator?this.generator.rollback():e.pushBackToken());break}if(n instanceof T&&n.isDevided()){e.pushBackToken();break}}}return t=e.createLine(),this.hasNext()||this._onLastTree(e,t),this._onCompleteTree(e,t),t},_onLastTree:function(){},_onCompleteTree:function(t,e){e.setMaxExtent(t.getMaxExtent()),e.setMaxFontSize(t.getMaxFontSize()),this.lineNo++},_yieldElement:function(t){if(this.generator&&this.generator.hasNext())return this.generator.yield(t.line);this.generator=null;var e=t.getNextToken();return this._yieldToken(t,e)},_yieldToken:function(t,e){return null===e?k.BUFFER_END:e instanceof B?e:S.isChar(e)&&e.isNewLineChar()?t.isPreLine()?k.LINE_BREAK:k.IGNORE:S.isText(e)?this._yieldText(t,e):S.isTag(e)&&"br"===e.getName()?k.LINE_BREAK:(S.isTag(e)&&"first-letter"===e.getName()&&e.setFirstLetter(),e.isBlock()?(t.pushBackToken(),this._terminate=!0,k.LINE_BREAK):e.hasStaticSize()?this._yieldStaticElement(t.line,e):e.isInlineBlock()?(this.generator=new Qe(e,t.createInlineRoot()),this.generator.yield(t.line)):this._yieldInlineTag(t,e))},_yieldText:function(t,e){switch(e.hasMetrics()||e.setMetrics(t.getLineFlow(),t.getFontSize(),t.isTextBold()),e._type){case"char":case"tcy":return e;case"word":return this._yieldWord(t,e)}},_yieldWord:function(t,e){var n=e.getAdvance(t.getLineFlow(),t.getLetterSpacing());if(t.maxMeasure>=n)return e.setDevided(!1),e;var i=t.getFontSize(),r=t.maxMeasure,s=t.isTextBold(),a=t.getLineFlow(),o=e.cutMeasure(i,r);return o.setMetrics(a,i,s),e.setMetrics(a,i,s),o},_yieldInlineTag:function(t,e){if(e.isSingleTag())return e;switch(e.getName()){case"script":return t.addScript(e),k.IGNORE;case"style":return t.addStyle(e),k.IGNORE;default:return this.generator=this._createChildInlineTreeGenerator(t,e),this.generator.yield(t.line)}},_createChildInlineTreeGenerator:function(t,e){switch(e.getName()){case"ruby":return new $e(e,this.context);case"a":return new Ze(e,this.context);default:return new Ue(e,this.context)}}}),Ue=qe.extend({init:function(t,e){this.markup=t,this.context=e,this.context.pushInlineTag(this.markup),this.stream=this._createStream(),this.lineNo=0},_createStream:function(){return new Be(this.markup.getContent())},_createLine:function(t){var e=this._super(t);return this._setBoxStyle(e,t),e},_getLineSize:function(t){var e=t.getTextRestMeasure(),n=t.getContentExtent();return t.flow.getBoxSize(e,n)},_onLastTree:function(){this.context.popInlineTag()},_onCompleteTree:function(t,e){e.shortenMeasure(),this.lineNo++}}),$e=Ue.extend({_createStream:function(){return new Fe(this.markup.getContent())},_yieldElement:function(t){var e=this._super(t);return"number"==typeof e?e:(e.hasMetrics()||e.setMetrics(t.getLineFlow(),t.getFontSize(),t.getLetterSpacing()),e)}}),Xe=Ue.extend({_getLineSize:function(t){var e=t.getContentMeasure(),n=t.getContentExtent();return t.flow.getBoxSize(e,n)}}),Ze=Ue.extend({init:function(t,e){this._super(t,e);var n=t.getTagAttr("name");n&&e.setAnchor(n)}}),Ye=function(){function t(t,e,n){this.page=t,this.stream=e,this.context=n,this.curExtent=0,this.maxExtent=t.getContentExtent(),this.flow=t.flow}return t.prototype={addElement:function(t){var e=t.getBoxExtent(this.flow);if(t instanceof ce&&!t.isTextLine()&&0>=e)throw"EmptyBlock";if(this.curExtent+e>this.maxExtent)throw"OverflowBlock";if(this.page.addChildBlock(t),this.curExtent+=e,this.curExtent===this.maxExtent)throw"FinishBlock"},pushBackToken:function(){this.stream.prev()},getNextToken:function(){var t=this.stream.get();return t&&S.isTag(t)&&this.context.inheritTag(t),t}},t}(),Je=We.extend({init:function(t,e){this._super(t,e),this.context.pushBlockTag(this.markup),this.generator=null,this.stream=this._createStream(),this.localPageNo=0},hasNext:function(){return this.generator&&this.generator.hasNext()?!0:this.stream.hasNext()},backup:function(){this.stream.backup()},rollback:function(){this.generator?this.generator.rollback():this.stream.rollback()},getCurGenerator:function(){return this.generator&&this.generator.hasNext()?this.generator:null},yield:function(t,e){var n,i;i=e||this._getBoxSize(t),n=this._createBox(i,t);var r=this._yieldPageTo(n);return r},_getBoxSize:function(t){return this._getMarkupStaticSize()||t.getRestSize()},_yieldPageTo:function(t){for(var e=new Ye(t,this.stream,this.context);;){this.backup();var n=this._yieldPageElement(e,t);if(n==k.PAGE_BREAK)break;if(n==k.BUFFER_END)break;if(n==k.SKIP)break;if(n==k.RETRY){this.rollback();break}if(n==k.BREAK)break;if(n!=k.IGNORE)try{e.addElement(n)}catch(i){("OverflowBlock"===i||"EmptyBlock"===i)&&this.rollback();break}}return this.localPageNo>0&&t.clearBorderBefore(),this.hasNext()?t.clearBorderAfter():this._onLastTree(t),this._onCompleteTree(t),t.getBoxExtent()>0&&this.localPageNo++,t},_isEmptyElement:function(t,e){return e instanceof ce&&!e.isTextLine()&&0>=e.getContentExtent(t)},_createStream:function(){var t=this._createSource(this.markup.getContent());return new Be(t)},_createSource:function(t){return t.replace(/^[ \n]+/,"").replace(/\s+$/,"").replace(/\r/g,"")},_onLastTree:function(){this.context.popBlockTag()},_onCompleteTree:function(){},_yieldPageElement:function(t,e){if(this.generator&&this.generator.hasNext())return this.generator.yield(e);var n=t.getNextToken();return null===n?k.BUFFER_END:S.isChar(n)&&n.isNewLineChar()?k.IGNORE:S.isTag(n)&&n.isPageBreakTag()?k.PAGE_BREAK:(S.isTag(n)&&"first-letter"===n.getName()&&n.setFirstLetter(),S.isInline(n)?(t.pushBackToken(),this.generator=new qe(this.markup,this.stream,this.context),this.generator.yield(e)):this._yieldBlockElement(e,n))},_yieldBlockElement:function(t,e){if(e.hasStaticSize())return this._yieldStaticTag(t,e);if(e.hasFlow()&&e.getCssAttr("flow")!=t.getFlowName()){var n=t.getRestSize(),i=new on(e,this.context.createInlineRoot());return i.yield(t,n)}return this.generator=this._createChildBlockTreeGenerator(t,e),this.generator.yield(t)},_yieldStaticTag:function(t,e){var n=this._yieldStaticElement(t,e);return n instanceof ce?e.isPush()?n:n instanceof ce&&n.logicalFloat?this._yieldFloatedBlock(t,n,e):n:n},_yieldFloatedBlock:function(t,e){var n=new an(this.stream,this.context,e),i=n.yield(t);return this.generator=n.getCurGenerator(),i},_createChildBlockTreeGenerator:function(t,e){switch(e.getName()){case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":return this._getHeaderLineGenerator(t,e);case"section":case"article":case"nav":case"aside":return this._getSectionContentGenerator(t,e);case"details":case"blockquote":case"figure":case"fieldset":return this._getSectionRootGenerator(t,e);case"table":return this._getTableGenerator(t,e);case"tbody":case"thead":case"tfoot":return this._getTableRowGroupGenerator(t,e);case"tr":return this._getTableRowGenerator(t,e);case"dl":return this._getDefListGenerator(t,e);case"ul":case"ol":return this._getListGenerator(t,e);case"li":return this._getListItemGenerator(t,e);case"hr":return this._getHrGenerator(t,e);default:return new tn(e,this.context)}},_getSectionContentGenerator:function(t,e){return new en(e,this.context)},_getSectionRootGenerator:function(t,e){return new nn(e,this.context)},_getHrGenerator:function(t,e){return new Ke(e,this.context)},_getHeaderLineGenerator:function(t,e){return new rn(e,this.context)},_getListGenerator:function(t,e){return new gn(e,this.context)},_getListItemGenerator:function(t,e){var n=t.listStyle||null;return null===n?new tn(e,this.context):n.isInside()?new dn(e,t,this.context):new pn(e,t,this.context)},_getDefListGenerator:function(t,e){return new mn(e,this.context)},_getTableGenerator:function(t,e){return new ln(e,this.context)},_getTableRowGroupGenerator:function(t,e){return new cn(e,this.context)},_getTableRowGenerator:function(t,e){return new fn(e,t,this.context.createInlineRoot())}}),Qe=Je.extend({_getBoxType:function(){return"inline-block"}}),tn=Je.extend({_onCompleteTree:function(t){t.shortenExtent(t.getParentFlow())}}),en=tn.extend({init:function(t,e){this._super(t,e),this.context.logStartSection(t)},_onLastTree:function(){this.context.logEndSection(this.markup)}}),nn=tn.extend({init:function(t,e){this._super(t,e),this.context.startSectionRoot(t)},hasOutline:function(t){var e=this.getOutlineBuffer(t);return e.isEmpty()===!1},getOutlineBuffer:function(t){var e=t||this.markup.getName();return this.context.getOutlineBuffer(e)},getOutlineTree:function(t){var e=this.getOutlineBuffer(t),n=new be(e).getTree();return n},getAnchors:function(){return this.context.getAnchors()},getAnchorPageNo:function(t){return this.context.getAnchorPageNo(t)},setAnchor:function(t,e){this.context.setAnchor(t,e)},_onLastTree:function(){this.context.endSectionRoot(this.markup),this._super()}}),rn=tn.extend({_onCompleteTree:function(t){this._super(t),t.id=d.addNehanHeaderPrefix(this.context.logSectionHeader(this.markup))},_onCreateBox:function(t){t.addClass("nehan-header")}}),sn=nn.extend({init:function(t,e){var n=e||new we,i=t;"string"==typeof t&&(i=new _("<body>",t)),this._super(i,n)},_getBoxSize:function(){return i.getStdPageSize()},_createBox:function(t){var e=i.createRootBox(t,"body");return this._setBoxStyle(e,null),e.percent=this.stream.getSeekPercent(),e.seekPos=this.stream.getSeekPos(),e.pageNo=this.context.getPageNo(),e.charPos=this.context.getCharPos(),e.lazy=this.context.isEmptyMarkupContext(),e.css["font-size"]=i.fontSize+"px",e},_onCompleteTree:function(t){t.lazy=t.lazy&&this.context.isEmptyMarkupContext(),this.context.stepPageNo(),this.context.addCharPos(t.getCharCount())}}),an=Je.extend({init:function(t,e,n){this.context=e,this.stream=t,this.floatedBox=n},_onLastTree:function(){},yield:function(t){var e=this.stream.backupPos,n=this._getFloatedWrapBox(t,this.floatedBox),i=this._getFloatedRestBox(t,n,this.floatedBox);return this._yieldPageTo(i),"start"===this.floatedBox.logicalFloat?(n.addChildBlock(this.floatedBox),n.addChildBlock(i)):(n.addChildBlock(i),n.addChildBlock(this.floatedBox)),this.stream.backupPos=e,n},_getFloatedRestBox:function(t,e,n){var r=t.getContentMeasure()-n.getBoxMeasure(t.flow),s=n.getBoxExtent(t.flow),a=t.flow.getBoxSize(r,s),o=i.createBox(a,e,"box");return o.setFlow(t.flow),o},_getFloatedWrapBox:function(t,e){var n=t.getContentMeasure(),r=e.getBoxExtent(t.flow),s=t.flow.getBoxSize(n,r),a=i.createBox(s,t,"box"),o=t.getFloatedWrapFlow();return a.setParent(t,!1),a.setFlow(o),e.setParent(a,!0),a}}),on=Je.extend({hasNext:function(){return!1},yield:function(t){var e=this._getBoxSize(t),n=i.createBox(e,t,"div"),r=this._super(n);return"number"==typeof r?r:(n.addChildBlock(r),n.logicalFloat=r.logicalFloat,n)}}),un=tn.extend({init:function(t,e,n,i){this.generators=t,this.markup=e,this.context=n,this.partition=i},hasNext:function(){return o.exists(this.generators,function(t){return t.hasNext()})},backup:function(){o.iter(this.generators,function(t){t.backup()})},rollback:function(){o.iter(this.generators,function(t){t.rollback()})},yield:function(t){this.backup();var e=t.getRestSize(),n=this._createBox(e,t),i=t.getParallelFlow();return n.setFlow(i),this._yieldChilds(n,t)},_setBoxEdge:function(){},_getChildMeasure:function(t){return this.partition.getSize(t)},_getChildExtent:function(t){return t.getRestContentExtent()},_yieldChilds:function(t,e){var n=this,i=e.flow,r=function(t){return t&&t.getContentExtent},s=o.mapi(this.generators,function(r,s){var a=n._getChildMeasure(r),o=n._getChildExtent(e),u=i.getBoxSize(a,o);return s.yield(t,u)});if(!o.exists(s,r))return k.RETRY;var a=o.maxobj(s,function(t){return t&&t.getContentExtent?t.getContentExtent():0}),u=a.getContentExtent(),h=a.getBoxExtent();return t.setContentExtent(e.flow,h),o.iter(s,function(e){e&&(e.setContentExtent(i,u),t.addChildBlock(e))}),t}}),hn=tn.extend({_onReadyBox:function(t,e){var n=e.getParallelFlipFlow();t.setFlow(n)}}),ln=tn.extend({_createStream:function(){return new Me(this.markup)},_onReadyBox:function(t){"collapse"===this.markup.getCssAttr("border-collapse")&&this.collapse===void 0&&(Ee.set(this.markup,t),this.collapse=!0)},_onCreateBox:function(t){t.partition=this.stream.getPartition(t)}}),cn=tn.extend({_onCreateBox:function(t,e){t.partition=e.partition},_createStream:function(){return new Pe(this.markup.tableChilds)}}),fn=un.extend({init:function(t,e,n){var i=e.partition.getPartition(t.tableChilds.length),r=o.map(t.tableChilds,function(t){return new hn(t,n.createInlineRoot())});this._super(r,t,n,i)}}),gn=tn.extend({_onCreateBox:function(t,e){var n=this.stream.getTokenCount(),i=this.markup.getCssAttr("list-style-type","none"),r=this.markup.getCssAttr("list-style-position","outside"),s=this.markup.getCssAttr("list-style-image","none"),a=this.markup.getCssAttr("list-style-format"),o=new F({type:i,position:r,image:s,format:a}),u=o.getMarkerAdvance(e.flow,e.fontSize,n);t.listStyle=o,t.partition=new ie([u,t.getContentMeasure()-u])},_createStream:function(){return new Re(this.markup.getContent())}}),dn=tn.extend({init:function(t,e,n){var i=e.listStyle.getMarkerHtml(t.order+1),r=p.tagWrap("span",i,{"class":"nehan-li-marker"});t.content=r+g.space+t.getContent(),this._super(t,n)}}),pn=un.extend({init:function(t,e,n){var i=e.listStyle.getMarkerHtml(t.order+1),r=new _("<li-marker>",i),s=new _("<li-body>",t.getContent());this._super([new hn(r,n),new hn(s,n)],t,n,e.partition)}}),mn=tn.extend({_createStream:function(){return new Le(this.markup.getContent())}}),xn=function(){function t(t){x.merge(this,{html:"",groupLength:1,seekPos:0,pageNo:0,charPos:0,charCount:0,percent:0},t)}return t.prototype={isGroup:function(){return this.groupLength>1},getPercent:function(){return this.percent},getPageNo:function(){return this.pageNo},getGroupCount:function(){return this.groupLength},getPageCount:function(){return this.isGroup()&&this.html instanceof Array?this.html.length:1},getHtml:function(t){return this.isGroup()?this.html[t]||"":this.html}},t}(),kn=function(){function t(){this.blockEvaluator=new vn}return t.prototype={evaluate:function(t){return new xn({html:this.blockEvaluator.evaluate(t),percent:t.percent,seekPos:t.seekPos,pageNo:t.pageNo,charPos:t.charPos,charCount:t.charCount})}},t}(),vn=function(){function t(){this.inlineEvaluatorH=new Cn(this),this.inlineEvaluatorV=new yn(this)}return t.prototype={evaluate:function(t){switch(t._type){case"br":return this.evalBreak(t);case"hr":return this.evalHr(t);case"ibox":return this.evalInlineBox(t);case"ipage":return this.evalInlinePage(t);case"img":return this.evalImage(t);case"table":return this.evalTable(t);case"text-line":return this.evalTextLine(t);default:return this.evalBox(t)}},evalBox:function(t){var e={style:d.toString(t.getCssBlock()),"class":t.getCssClasses()};return t.id&&(e.id=t.id),p.tagWrap("div",this.evalBoxChilds(t.getChilds()),e)},evalBoxChilds:function(t){var e=this;return o.fold(t,"",function(t,n){return[t,e.evaluate(n)].join("\n")})},evalTextLine:function(t){return t.isTextVertical()?this.inlineEvaluatorV.evaluate(t):this.inlineEvaluatorH.evaluate(t)},evalInlineBox:function(t){return p.tagWrap("div",t.content,{style:d.toString(t.getCssBlock()),"class":t.getCssClasses()})},evalHr:function(t){return this.evalInlineBox(t)},evalBreak:function(t){return this.evalInlineBox(t)},evalImage:function(t){var e=this.evalImageContent(t);return p.tagWrap("div",e,{style:d.toString(t.getCssBlock()),"class":t.getCssClasses()})},evalImageContent:function(t){return p.tagSingle("img",{src:t.src,width:t.getContentWidth(),height:t.getContentHeight()})},evalInlinePage:function(t){return this.evalBox(t)},evalTable:function(t){return this.evalBox(t)}},t}(),bn=a.extend({init:function(t){this.parentEvaluator=t},evaluate:function(){throw"InlineTreeEvaluator::evaluate not implemented"},evalTextLineBody:function(t,e){var n=this,i=o.fold(e,"",function(e,i){return e+n.evalInlineElement(t,i)});return t.isLinkLine()?this.evalLinkLine(t,i):i},evalLinkLine:function(t,e){var n={},i=t.markup;n.href=i.getTagAttr("href","#");var r=i.getTagAttr("name");r&&(i.addClass("nehan-anchor"),n.name=r);var s=i.getTagAttr("target");return s&&(n.target=s),n.href.indexOf("#")>=0&&i.addClass("nehan-anchor-link"),n["class"]=i.getCssClasses(),p.tagWrap("a",e,n)},evalInlineElement:function(t,e){return"text-line"===e._type?this.evaluate(e):e instanceof B?this.evalRuby(t,e):S.isText(e)?this.evalText(t,e):e instanceof ce?this.evalInlineBox(t,e):""},evalText:function(t,e){switch(e._type){case"word":return this.evalWord(t,e);case"tcy":var n=this.evalTcy(t,e);return t.textEmpha?this.evalEmpha(t,e,n):n;case"char":var i=this.evalChar(t,e);return t.textEmpha?this.evalEmpha(t,e,i):i;default:return""}},evalInlineBox:function(){throw"not implemented: evalInlineBox"},evalWord:function(){throw"not implemented: evalWord"},evalTcy:function(){throw"not implemented: evalTcy"},evalChar:function(){throw"not implemented: evalChar"}}),yn=bn.extend({evaluate:function(t){return p.tagWrap("div",this.evalTextLineBody(t,t.getChilds()),{style:d.toString(t.getCssInline()),"class":t.getCssClasses()})},evalRuby:function(t,e){var n=this.evalRb(t,e)+this.evalRt(t,e);return p.tagWrap("div",n,{style:d.toString(e.getCssVertRuby(t)),"class":"nehan-ruby-body"})},evalRb:function(t,e){var n=this.evalTextLineBody(t,e.getRbs());return p.tagWrap("div",n,{style:d.toString(e.getCssVertRb(t)),"class":"nehan-rb"})},evalRt:function(t,e){var n=new Xe(e.rt,new we),i=n.yield(t),r=e.getCssVertRt(t);for(var s in r)i.setCss(s,r[s]);return this.evaluate(i)},evalWord:function(t,e){return r.isTransformEnable?this.evalWordTransform(t,e):r.isIE?this.evalWordIE(t,e):""},evalWordTransform:function(t,e){var n=p.tagWrap("div",e.data,{"class":"nehan-vert-alpha"});return p.tagWrap("div",n,{style:d.toString(e.getCssVertTrans(t))})},evalWordIE:function(t,e){return p.tagWrap("div",e.data,{"class":"nehan-vert-alpha-ie",style:d.toString(e.getCssVertTransIE(t))})},evalTcy:function(t,e){return p.tagWrap("div",e.data,{"class":"nehan-tcy"})},evalChar:function(t,e){return e.isImgChar()?e.isVertGlyphEnable()?this.evalVerticalGlyph(t,e):this.evalImgChar(t,e):e.isHalfSpaceChar(e)?this.evalHalfSpaceChar(t,e):e.isCnvChar()?this.evalCnvChar(t,e):e.isSmallKana()?this.evalSmallKana(t,e):e.isPaddingEnable()?this.evalPaddingChar(t,e):t.letterSpacing?this.evalCharLetterSpacing(t,e):e.data+"<br />"},evalCharLetterSpacing:function(t,e){return p.tagWrap("div",e.data,{style:d.toString(e.getCssVertLetterSpacing(t))})},evalEmpha:function(t,e,n){n=n.replace("<br />","");var i=p.tagWrap("span",n,{"class":"nehan-empha-src",style:d.toString(e.getCssVertEmphaSrc(t))}),r=p.tagWrap("span",t.textEmpha.getText(),{"class":"nehan-empha-text",style:d.toString(e.getCssVertEmphaText(t))});return p.tagWrap("div",i+r,{"class":"nehan-empha-wrap",style:d.toString(t.textEmpha.getCssVertEmphaWrap(t,e))})},evalPaddingChar:function(t,e){return p.tagWrap("div",e.data,{style:d.toString(e.getCssPadding(t))})},evalImgChar:function(t,e){var n=t.color.getRgb(),i=N.getColor(n).toUpperCase();return p.tagSingle("img",{"class":"nehan-img-char",src:e.getImgSrc(i),style:d.toString(e.getCssVertImgChar(t))})+g.clearFix},evalVerticalGlyph:function(t,e){return p.tagWrap("div",e.data,{"class":"nehan-vert-rl",style:d.toString(e.getCssVertGlyph(t))})},evalCnvChar:function(t,e){return e.cnv+"<br />"},evalSmallKana:function(t,e){var n=t.textEmpha?"span":"div";return p.tagWrap(n,e.data,{style:d.toString(e.getCssVertSmallKana())})},evalHalfSpaceChar:function(t,e){return Math.floor(t.fontSize/2),p.tagWrap("div","&nbsp;",{style:d.toString(e.getCssVertHalfSpaceChar(t))})},evalInlineBox:function(t,e){var n="img"===e._type?this.parentEvaluator.evalImageContent(e):e.content;return p.tagWrap("div",n,{style:d.toString(e.getCssVertInlineBox())})}}),Cn=bn.extend({evaluate:function(t,e){var n=t.isInlineOfInline()?"span":"div";return p.tagWrap(n,this.evalTextLineBody(t,t.getChilds(),e),{style:d.toString(t.getCssInline()),"class":t.getCssClasses()})},evalRuby:function(t,e,n){var i=this.evalRt(t,e,n)+this.evalRb(t,e,n);return p.tagWrap("span",i,{style:d.toString(e.getCssHoriRuby(t)),"class":"nehan-ruby"})},evalRb:function(t,e,n){var i=this.evalTextLineBody(t,e.getRbs(),n);return p.tagWrap("div",i,{style:d.toString(e.getCssHoriRb(t)),"class":"nehan-rb"})},evalRt:function(t,e){return p.tagWrap("div",e.getRtString(),{style:d.toString(e.getCssHoriRt(t)),"class":"nehan-rt"})},evalWord:function(t,e){return e.data},evalTcy:function(t,e){return e.data},evalChar:function(t,e,n){return e.isHalfSpaceChar()?e.cnv:e.isKerningChar()?this.evalKerningChar(t,e,n):e.data},evalEmpha:function(t,e,n){var i=p.tagWrap("div",n,{style:d.toString(e.getCssHoriEmphaSrc(t))}),r=p.tagWrap("div",t.textEmpha.getText(),{style:d.toString(e.getCssHoriEmphaText(t))});
return p.tagWrap("span",r+i,{style:d.toString(t.textEmpha.getCssHoriEmphaWrap(t,e))})},evalKerningChar:function(t,e){var n=e.getCssPadding(t);return e.isKakkoStart()?p.tagWrap("span",e.data,{style:d.toString(n),"class":"nehan-char-kakko-start"}):e.isKakkoEnd()?p.tagWrap("span",e.data,{style:d.toString(n),"class":"nehan-char-kakko-end"}):e.isKutenTouten()?p.tagWrap("span",e.data,{style:d.toString(n),"class":"nehan-char-kuto"}):e.data},evalPaddingChar:function(t,e){return p.tagWrap("span",e.data,{style:d.toString(e.getCssPadding(t))})},evalInlineBox:function(t,e){return e.display="inline-block",this.parentEvaluator.evaluate(e)}}),_n=function(){function t(){this.evaluator=new kn}return t.prototype={evaluate:function(t){var e=this,n=0,i=[],r=!0,s=o.map(t.getPages(),function(t){var s=e.evaluator.evaluate(t);return s.lazy||(r=!1),n+=s.charCount,i.push(s.html),s}),a=s[0];return new xn({html:i,groupLength:t.getSize(),percent:a.percent,seekPos:a.seekPos,pageNo:a.pageNo,charPos:a.charPos,charCount:n})}},t}(),Sn=a.extend({init:function(t){this.text=this._createSource(t),this.generator=this._createGenerator(this.text),this.evaluator=this._createEvaluator(),this.buffer=[],this._timeStart=null,this._timeElapsed=null,this._seekPageNo=0,this._seekPercent=0,this._seekPos=0},hasPage:function(t){return this.buffer[t]!==void 0},hasNext:function(){return this.generator.hasNext()},hasOutline:function(t){return this.generator.hasOutline(t)},getNext:function(){if(!this.hasNext())return null;var t=this._seekPageNo;if(!this.hasPage(t)){var e=this._yield();this._addBuffer(e),this._seekPageNo++,this._seekPercent=e.percent,this._seekPos=e.seekPos}return this.get(t)},get:function(t){var e=this.buffer[t];if(e instanceof xn)return e;var n=this.evaluator.evaluate(e);return this.buffer[t]=n,n},getPageCount:function(){return this.buffer.length},getOutlineTree:function(t){return this.generator.getOutlineTree(t||"body")},getOutlineNode:function(t,e){var n=this.getOutlineTree(t),i=new ye(n,e||{});return i.outputNode()},getAnchors:function(){return this.generator.getAnchors()},getAnchorPageNo:function(t){return this.generator.getAnchorPageNo(t)},getSeekPageResult:function(){return this.get(this._seekPageNo)},getSeekPageNo:function(){return this._seekPageNo},getSeekPercent:function(){return this._seekPercent},getSeekPos:function(){return this._seekPos},setAnchor:function(t,e){this.generator.setAnchor(t,e)},getTimeElapsed:function(){return this._timeElapsed},syncGet:function(){for(this._setTimeStart();this.generator.hasNext();)this.getNext();return this._setTimeElapsed()},asyncGet:function(t){x.merge(this,{onComplete:function(){},onProgress:function(){}},t||{}),this._setTimeStart(),this._asyncGet(t.wait||0)},_yield:function(){return this.generator.yield()},_setTimeStart:function(){return this._timeStart=(new Date).getTime(),this._timeStart},_setTimeElapsed:function(){return this._timeElapsed=(new Date).getTime()-this._timeStart,this._timeElapsed},_asyncGet:function(t){if(!this.generator.hasNext()){var e=this._setTimeElapsed();return this.onComplete(e),void 0}var n=this,i=this._yield();this._addBuffer(i),this.onProgress(this),this._seekPageNo++,this._seekPercent=i.percent,this._seekPos=i.seekPos,f(function(){n._asyncGet(t)})},_addBuffer:function(t){t.lazy||(t=this.evaluator.evaluate(t)),this.buffer.push(t)},_createSource:function(t){return t.replace(/(\/[a-zA-Z0-9\-]+>)[\s\n]+(<[^\/])/g,"$1$2").replace(/\t/g,"").replace(/<!--[\s\S]*?-->/g,"").replace(/<rp>[^<]*<\/rp>/gi,"").replace(/<rb>/gi,"").replace(/<\/rb>/gi,"").replace(/<rt><\/rt>/gi,"")},_createGenerator:function(t){switch(i.root){case"body":return new sn(t);case"html":return new Ve(t);default:return new He(t)}},_createEvaluator:function(){return new kn}}),wn=function(){function t(t){this.trees=[],this.size=t}return t.prototype={add:function(t){if(this.isComplete())throw"overflow";this.trees.push(t)},commit:function(){var t=this.getFirst(),e=this.getLast();this.lazy=t.lazy&&e.lazy,this.percent=t.percent,this.seekPos=t.seekPos,this.pageNo=t.pageNo},isEmpty:function(){return 0===this.trees.length},isComplete:function(){return this.trees.length>=this.size},getFirst:function(){return this.trees[0]},getLast:function(){return this.trees[this.trees.length-1]},get:function(t){return this.trees[t]},getPages:function(){return this.trees},getSize:function(){return this.size},getLength:function(){return this.trees.length}},t}(),Tn=Sn.extend({init:function(t,e){this._super(t),this.groupSize=e},getAnchorPageNo:function(t){var e=this._super(t);return this.getGroupPageNo(e)},getGroupPageNo:function(t){return Math.floor(t/this.groupSize)},_yield:function(){for(var t=new wn(this.groupSize),e=function(e){t.add(e)},n=0;this.groupSize>n&&this.generator.hasNext();n++)e(this.generator.yield());return t.commit(),t},_createEvaluator:function(){return new _n}});Nehan.version="4.0.2",x.copy(r,e.env||{}),x.copy(i,e.layout||{}),x.copy(n,e.config||{});var En={};return e.test&&(En.Class=a,En.Utils=l,En.MathUtils=c,En.Obj=u,En.Css=d,En.Html=p,En.Closure=m,En.Args=x,En.List=o,En.Color=P,En.Colors=I,En.Flow=H,En.InlineFlow=W,En.BlockFlow=V,En.BoxFlow=O,En.BoxFlows=G,En.Edge=$,En.EdgeParser=EdgeParser,En.CornerParser=CornerParser,En.CssParser=v,En.Padding=Q,En.Margin=te,En.Border=ee,En.BorderColor=Y,En.BorderRadius=Z,En.Radius2d=X,En.BoxEdge=ne,En.BoxSize=se,En.LogicalSize=he,En.BoxSizing=j,En.BoxSizings=q,En.UnitSize=h,En.BoxChild=le,En.Box=ce,En.Selector=b,En.Tag=_,En.Char=w,En.Word=T,En.Tcy=E,En.Ruby=B,En.Lexer=ge,En.Token=S,En.TagStack=de,En.InlineContext=Se,En.BlockContext=_e,En.DocumentContext=we,En.TocContext=xe,En.EvalResult=xn,En.PageGroup=wn,En.Partition=ie,En.Cardinal=A,En.ListStyle=F,En.ListStyleType=M,En.ListStylePos=R,En.ListStyleImage=L,En.OutlineBuffer=ke,En.OutlineContext=ve,En.OutlineParser=be,En.OutlineConverter=ye,En.TokenStream=Be,En.DocumentTagStream=Ie,En.HtmlTagStream=Ne,En.HeadTagStream=Ae,En.ListTagStream=Re,En.DefListTagStream=Le,En.TableTagStream=Me,En.RubyTagStream=Fe,En.ElementGenerator=We,En.InlineTreeGenerator=qe,En.BlockTreeGenerator=Je,En.BodyBlockTreeGenerator=sn,En.ParallelGenerator=un,En.ParaChildGenerator=hn,En.HtmlGenerator=Ve,En.DocumentGenerator=He,En.PageEvaluator=kn,En.BlockTreeEvaluator=vn,En.InlineTreeEvaluator=bn,En.PageGroupEvaluator=_n,En.PageStream=Sn,En.PageGroupStream=Tn,En.Env=r,En.Config=n,En.Layout=i,En.Style=s,En.Selectors=y),En.createPageStream=function(t,e){return e=Math.max(1,e||1),1===e?new Sn(t):new Tn(t,e)},En.getStyle=function(t){return y.getValue(t)},En.setStyle=function(t,e){y.setValue(t,e)},En.setStyles=function(t){for(var e in t)y.setValue(e,t[e])},En};